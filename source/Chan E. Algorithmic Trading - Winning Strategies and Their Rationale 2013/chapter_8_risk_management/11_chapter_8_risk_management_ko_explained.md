---
lang: ko
format:
  html:
    toc: true
    embed-resources: true
    theme: cosmo
---

# 제8장: 리스크 관리 — 쉬운 해설판

> 이 글은 Ernest Chan의 "Algorithmic Trading" 제8장의 전체 내용을 빠짐없이 담되, 전문 용어와 개념을 일상적인 비유와 풀어쓴 설명으로 재구성한 해설판입니다.

---

## 리스크 관리란 무엇이고, 왜 중요한가?

여러분, 자동차를 운전할 때를 떠올려 보세요. 안전벨트, 에어백, ABS 브레이크, 사각지대 감지 시스템... 이 모든 것이 하나의 목적을 위해 존재합니다 — **사고가 나더라도 치명적인 피해를 막는 것**입니다. 리스크 관리는 트레이딩 세계에서 바로 이 **자동차의 안전장치 시스템**과 같은 역할을 합니다. 아무리 운전 실력이 뛰어나도 안전장치 없이 도로에 나서는 것은 무모한 일이듯, 아무리 좋은 전략이 있어도 리스크 관리 없이 시장에 뛰어드는 것은 재앙을 자초하는 길입니다.

리스크 관리는 사람마다 다른 의미를 가집니다. 초보 트레이더에게 리스크 관리는 **"손실 회피(loss aversion)"** — 즉 돈을 잃는 느낌 자체를 싫어하는 심리에 의해 주도됩니다. 실제로, 행동경제학 연구에 따르면 평균적인 인간은 1달러를 잃을 위험을 감수하기 위해 무려 **2달러를 벌 수 있는 잠재력**이 필요하다고 합니다. 쉽게 말해, 우리는 같은 금액이라도 "잃는 고통"이 "버는 기쁨"보다 두 배나 크게 느껴진다는 것이죠! 이것이 바로 **샤프 비율(Sharpe ratio)** 2가 감정적으로 그토록 매력적인 이유를 설명할 수 있습니다 (Kahneman, 2011).

> **샤프 비율(Sharpe ratio)**: 위험 대비 수익률을 측정하는 지표입니다. 샤프 비율 2라는 것은 위험 1단위당 수익 2단위를 얻는다는 뜻으로, 바로 우리의 심리적 "손실 혐오" 임계값과 딱 맞아떨어집니다.

그러나 — 여기가 핵심입니다 — 이러한 리스크에 대한 혐오 자체는 합리적이지 않습니다. 마치 "나는 비행기가 무서워서 절대 안 타요"라고 하는 것이 통계적으로 비합리적인 것과 비슷합니다. 우리의 진정한 목표는 **장기적인 자산 성장의 극대화**여야 하며, 이 목표를 방해하는 한에서만 리스크를 피해야 합니다. 이 장에서 다루는 리스크 관리는 바로 이 냉정하고 수학적인 목표에 기반합니다.

### 이 장에서 다룰 내용 미리보기

자, 그럼 이 장에서 어떤 "안전장치들"을 배우게 될까요? 큰 그림을 먼저 그려보겠습니다.

1. **레버리지(leverage)의 신중한 사용** — 레버리지는 **지렛대**와 같습니다. 작은 힘으로 큰 바위를 움직일 수 있지만, 잘못 사용하면 자기 자신이 깔릴 수 있는 **양날의 검**이죠. **켈리 공식(Kelly formula)**이나 복리 성장률을 최대화하는 수치적 방법을 통해 최적화할 수 있습니다.

2. **최대 낙폭(maximum drawdown) 제한** — 낙폭은 **절벽에서 떨어지는 깊이**와 같습니다. 10미터 절벽에서 떨어져도 살 수 있지만, 100미터 절벽에서 떨어지면 끝입니다. 마찬가지로 계좌가 얼마나 깊이 "떨어질" 수 있는지를 제한해야 합니다.

3. **손절매(stop loss)** — 운전 중 위험을 감지하면 급브레이크를 밟는 것과 같습니다. 그런데 이것이 항상 최선의 방법일까요? 놀랍게도, 상황에 따라 다릅니다.

4. **고정 비율 포트폴리오 보험(Constant Proportion Portfolio Insurance, CPPI)** — 큰 낙폭을 방지하면서도 계좌의 상승 여력을 최대화하려는 영리한 방법입니다.

5. **선행 리스크 지표** — 도로의 노란 경고등처럼, 위험한 시기가 오기 *전에* 미리 경고해주는 지표들입니다. 손실 위험이 높은 시기에는 거래를 완전히 피하는 것이 현명할 수 있습니다.

---

## 최적 레버리지 — 지렛대는 얼마나 길어야 할까?

### 왜 이것이 중요한가?

"레버리지를 사용할 때 신중해야 한다"고 말하기는 쉽습니다. 마치 "건강하려면 운동을 해야 한다"고 말하는 것처럼요. 진짜 어려운 질문은 **"그래서 정확히 얼마나?"**입니다. 특정 전략이나 포트폴리오에 대해 무엇이 신중하거나 최적의 레버리지를 구성하는지 결정하는 것은 훨씬 어렵습니다. 왜냐하면 명백히, **레버리지를 0으로 설정하면** 어떤 위험도 감수하지 않지만 **어떤 수익도 창출하지 못하기** 때문입니다. 지렛대를 아예 안 쓰면 바위가 꿈쩍도 안 하는 것과 같습니다.

일부 포트폴리오 매니저들, 특히 자신의 돈을 관리하고 자기 자신 외에는 누구에게도 책임을 지지 않는 분들에게, 거래의 유일한 목표는 **장기적으로 순자산을 극대화하는 것**입니다. 이런 분들은 중간에 계좌가 얼마나 출렁이는지(낙폭이나 수익률의 변동성)에 신경 쓰지 않습니다. "최종 목적지만 중요하지, 가는 길이 울퉁불퉁한 건 상관없다"는 철학이죠. 따라서 그들에게 최적의 레버리지란 **순자산 또는 동등하게 복리 성장률을 극대화할 수 있는 레버리지**를 의미합니다.

### 세 가지 방법, 하나의 목표

여기서 복리 성장률을 최대화하는 최적 레버리지를 계산하는 **세 가지 방법**을 논의할 것입니다.

| 방법 | 핵심 가정 | 장점 | 단점 |
|------|----------|------|------|
| **켈리 공식** | 수익률이 정규분포 | 가장 우아하고 간단 | 현실의 팻 테일 무시 |
| **몬테카를로 시뮬레이션** | 피어슨 시스템 분포 | 비가우시안 분포 처리 가능 | 시뮬레이션 의존 |
| **역사적 데이터 최적화** | 과거=미래 | 실제 데이터 사용 | 데이터 스누핑 편향 |

각 방법은 고유한 가정과 단점이 있으며, 어떤 방법을 채택해야 하는지에 대해 Chan은 불가지론적 입장을 유지합니다. 그러나 **모든 경우에서 공통적인 가정**이 있습니다:

- **기본 가정**: 시장 수익률의 미래 확률 분포가 과거와 동일하다. 이것은 보통 잘못된 가정이지만, 정량적 모델이 할 수 있는 최선입니다.
- **더 제한적인 가정**: 전략 자체의 수익률 확률 분포가 과거와 동일하다.
- **가장 제한적인 가정**: 전략의 수익률 확률 분포가 **가우시안(정규분포)**이다.

수학적 모델링에서 흔히 그렇듯이, 가장 제한적인 가정이 가장 우아하고 간단한 해결책을 제공합니다. 마치 물리학에서 "공기 저항을 무시하면..."으로 시작하는 문제가 가장 풀기 쉬운 것과 같습니다. 그래서 가우시안 가정 하의 켈리 공식부터 시작하겠습니다.

### 파산하면 게임 오버

한 가지 직관적인 포인트가 있습니다. 특정 레버리지를 사용한 계좌의 **최대 낙폭이 -100%**라면, 복리 성장률도 -100%가 됩니다. 즉, **자산이 0이 되면 아무리 좋은 기회가 와도 복구할 수 없습니다.** 게임에서 HP가 0이 되면 부활할 수 없는 것과 같습니다! 따라서 최적 레버리지는 역사상 어떤 시점에서도 **파산(자산이 0에 도달)하지 않아야** 합니다. 이것은 상당히 자명한 이야기입니다.

그러나 현실에서는 더 빡빡한 제약이 있습니다. 때때로 우리의 **리스크 매니저**(독립 트레이더에게는 배우자일 수도 있다고 Chan이 위트 있게 표현합니다!)는 1(=100%)보다 훨씬 작은 규모의 낙폭만 허용합니다. 이 경우, 허용된 최대 낙폭은 레버리지 최적화 문제에서 **추가 제약 조건**을 형성합니다.

### 일정 레버리지의 철칙 — 직관에 반하는 진실

최적 레버리지가 어떻게 결정되든, 하나의 중심 주제가 있습니다: **레버리지가 일정하게 유지되어야 한다는 것**입니다. 이것은 최대 낙폭 제약이 있든 없든 성장률을 최적화하는 데 필요합니다.

"일정한 레버리지를 유지한다"는 것이 다소 평범하게 들릴 수 있지만, 실행에 옮길 때는 **직관에 완전히 반하는** 행동을 요구합니다.

- **돈을 벌었을 때**: 더 많은 포지션을 추가해야 합니다 (승승장구할 때 판돈을 키운다!).
- **돈을 잃었을 때**: 포지션을 줄여야 합니다 (지고 있을 때 판돈을 줄인다!).

마치 카지노에서 이기면 베팅을 늘리고 지면 줄이는 것처럼 보이지만, 이것은 도박꾼의 미신이 아니라 **수학적으로 증명된 최적 전략**입니다.

### 예제 8.1: 일정 레버리지가 실제로 의미하는 것

이 예제를 통해 일정 레버리지 요구 사항이 실제로 어떤 의미인지 구체적으로 살펴보겠습니다.

**시작 조건:**
- 계좌 자본: **$100,000**
- 최적 레버리지: **5배**
- 따라서 포트폴리오 시장 가치: **$500,000** (= 5 x $100,000)

**1일차: $10,000 손실 발생**
- 새 자본: $100,000 - $10,000 = **$90,000**
- 포트폴리오 현재 가치: $500,000 - $10,000 = **$490,000**
- 레버리지 5 유지를 위한 목표 가치: 5 x $90,000 = **$450,000**
- **필요한 조치: 추가로 $40,000 청산** ($490,000 - $450,000)

여기서 핵심을 보셨나요? 이미 돈을 잃은 상태에서 **더 팔아야** 합니다. "손해 보고 있는데 왜 더 파나?"라고 느낄 수 있지만, 이것이 바로 리스크 관리 체계의 필수적인 부분입니다.

**2일차: $20,000 수익 발생**
- 새 자본: $90,000 + $20,000 = **$110,000**
- 레버리지 5 유지를 위한 목표 가치: 5 x $110,000 = **$550,000**
- 포트폴리오 현재 가치: $450,000 + $20,000 = **$470,000**
- **필요한 조치: $80,000 상당의 증권을 추가 매수** ($550,000 - $470,000)

이번에는 돈을 벌었으니 더 사야 합니다. 바라건대, **브로커가 이 모든 추가 증권을 구매할 현금을 빌려줄 것입니다!**

### 전염 효과 — 한 펀드의 자기 보존이 모두의 재앙이 되는 이유

많은 분석가들은 리스크 관리 기법의 이러한 "손실 상태에서의 매도" 특성이 **금융 위기 시 전염(contagion)**을 일으킨다고 믿습니다. 특히 이것은 **2007년 8월 퀀트 펀드 붕괴**의 원인으로 인용되었습니다 (Khandani and Lo, 2007).

왜 이런 일이 벌어질까요? 도미노를 생각해 보세요:

1. 많은 펀드들이 포트폴리오에서 **유사한 포지션**을 보유하고 있습니다.
2. 한 펀드가 (아마도 관련 없는 전략으로 인해) **손실을 입습니다**.
3. 일정 레버리지 요구 사항으로 인해 **모든 포트폴리오에서 포지션을 청산**합니다.
4. 이 청산이 **같은 포지션을 보유한 다른 모든 펀드에 손실**을 야기합니다.
5. 그 펀드들도 레버리지 유지를 위해 **청산을 시작**합니다.
6. **악순환(vicious cycle)**이 시작됩니다.

이것을 **"공유지의 비극(Tragedy of the Commons)"**이라고 생각할 수 있습니다: 한 펀드의 자기 보존("리스크 관리")이 모두에게 재앙을 초래할 수 있는 것입니다. 마치 극장에서 한 명이 "불이야!"라고 외치면 모두가 출구로 몰려가 더 큰 사고가 나는 것과 비슷합니다.

---

## 켈리 공식 — 최적 베팅 비율 계산기

### 왜 이것이 중요한가?

카지노에서 블랙잭을 할 때, 매 판마다 얼마를 걸어야 할까요? 전 재산? 아니면 1달러? **켈리 공식(Kelly Formula)**은 바로 이 질문에 대한 수학적으로 완벽한 답을 제공하는 **"최적 베팅 비율 계산기"**입니다. 원래 정보이론에서 유래한 이 공식은 트레이딩에 적용되면 놀라운 통찰을 줍니다.

### 공식과 그 의미

수익률의 확률 분포가 **가우시안(정규분포)**이라고 가정하면, 켈리 공식은 최적 레버리지 *f*에 대한 매우 간단한 답을 제공합니다:

$$f = m / s^2 \qquad (8.1)$$

이 공식을 하나씩 뜯어보겠습니다:

- **$f$** = **최적 레버리지** (우리가 알고 싶은 값). "내 자본의 몇 배를 투자해야 하는가?"
- **$m$** = **평균 초과 수익률**. 무위험 이자율(은행 예금 금리 같은 것)을 뺀 후의 평균 수익률입니다. "전략이 평균적으로 얼마나 버는가?"
- **$s^2$** = **초과 수익률의 분산**. 수익률이 평균에서 얼마나 퍼져 있는지를 나타냅니다. "전략의 수익률이 얼마나 출렁이는가?"

직관적으로 이해해 보면:
- **평균 수익률($m$)이 높을수록** 최적 레버리지가 커집니다 → "잘 벌면 더 많이 걸어라!"
- **변동성($s^2$)이 클수록** 최적 레버리지가 작아집니다 → "불확실하면 조심하라!"

이 공식에 대한 가장 좋은 설명 중 하나는 Edward Thorp(1997)의 논문에서 찾을 수 있으며, Chan도 *Quantitative Trading* (Chan, 2009)에서 전체 한 장을 이에 할애했습니다.

### 가우시안 가정이 유효할 때의 마법

가우시안 가정이 좋은 근사라면, 켈리 레버리지 *f*가 모든 이익이 재투자된다고 가정할 때 **자산의 가장 높은 복리 성장률**을 생성할 것임을 수학적으로 증명할 수 있습니다. 복리의 힘을 최대로 활용하는 정확한 지점을 찾아주는 것이죠!

### 과대 추정의 위험 — 왜 "하프-켈리"가 인기 있는가?

그러나 현실은 이상적이지 않습니다. 두 가지 근본적인 문제가 있습니다:

**첫째, 추정 오류 문제:**
가우시안 가정이 실제로 유효하더라도, 초과 수익률의 "진정한" 평균과 분산이 무엇인지 추정하려 할 때 필연적으로 **추정 오류**가 발생합니다. 아무리 좋은 추정 방법을 사용해도, 미래의 평균과 분산이 역사적인 것과 동일할 것이라는 보장은 없습니다.

**둘째, 비대칭적 결과:**
이 부분이 특히 중요합니다!

| 시나리오 | 결과 |
|---------|------|
| 레버리지를 **과대 추정** (너무 높게) | **파산** 가능성 — 자산이 0이 될 수 있음! |
| 레버리지를 **과소 추정** (너무 낮게) | 최적이 아닌 성장률 — 덜 벌 뿐 |

보셨나요? **과대 추정의 결과는 치명적**이고, 과소 추정의 결과는 "그저 덜 버는 것"일 뿐입니다. 마치 다리의 하중 한도가 10톤인데, 12톤 트럭이 지나가면 다리가 무너지지만, 8톤 트럭이 지나가면 그냥 안전하게 건너는 것과 같습니다. 많은 트레이더들은 정당하게 후자의 시나리오를 선호하며, 켈리 공식이 권장하는 것의 **절반에 해당하는 레버리지**를 일상적으로 배치합니다. 이것이 바로 소위 **하프-켈리(half-Kelly) 레버리지**입니다.

### Chan의 실전 경험

Chan의 실제 경험에 따르면, 켈리의 최적 레버리지는 반드시 사용해야 하는 레버리지가 아니라 **상한선(ceiling)**으로 보는 것이 가장 좋다고 합니다. 그 이유는:

1. **백테스트에서 주어진 켈리 레버리지가 너무 높아서** 브로커가 허용하는 최대 레버리지를 훨씬 초과하는 경우가 많습니다. 브로커가 레버리지 10배까지만 허용하는데 켈리가 30배를 권장하면 어떡합니까?

2. **비가우시안 수익률 분포** 때문에 켈리 레버리지가 백테스트에서조차 파산을 초래했을 가능성이 있습니다. 즉, 백테스트의 최대 낙폭이 켈리 레버리지를 사용하면 -1(=100% 손실)이 되는 경우입니다.

이런 경우에는 더 현실적인 비가우시안 분포를 사용하여 성장률을 **수치적으로 최적화**하는 것이 더 실용적입니다. 대안으로, **경험적, 역사적 수익률**에 대해 직접 최적화할 수도 있습니다. 이 두 방법은 뒤에서 자세히 다룹니다.

### 트리플 레버리지 ETF의 위험성 — 실전 통찰

켈리 최적 레버리지를 상한선으로만 사용하는 것도 때때로 흥미로운 통찰을 제공합니다. Chan은 한 번 **Russell 1000과 2000 지수** 모두 켈리 레버리지가 **약 1.8**이라고 계산했습니다.

그런데 ETF 후원사 Direxion은 이러한 지수를 추적하는 **트리플 레버리지 ETF**인 BGU와 TNA를 마케팅해 왔습니다. 설계상 레버리지가 **3**입니다. 켈리 최적값이 1.8인데 3배 레버리지를 사용한다? 이는 **최적의 1.67배**나 됩니다! 분명히 이러한 ETF의 순자산가치(NAV)가 **0이 될 실제 위험**이 있습니다. 후원사 자신도 쉽게 동의하듯이, 어떤 투자자도 이러한 ETF를 **매수하고 보유해서는 안 됩니다**. 단기 트레이딩 도구로만 사용해야 합니다.

### 다중 포트폴리오에 대한 켈리 공식 — 구매력 최적 배분

켈리 공식은 최적 레버리지 설정 외에 또 다른 강력한 용도가 있습니다: **다른 포트폴리오나 전략에 구매력을 최적으로 배분하는 방법**도 알려줍니다. 마치 여러 개의 화분에 물을 줄 때, 각 화분에 정확히 얼마만큼의 물을 줘야 하는지 알려주는 것과 같습니다.

$F$를 공통 자본 풀에 기반하여 다른 포트폴리오에 적용해야 하는 최적 레버리지의 열 벡터로 표시합니다. 예를 들어, $1의 자본이 있다면, $F = [3.2 \ 1.5]^T$는 첫 번째 포트폴리오의 시장 가치가 $3.2이고 두 번째 포트폴리오의 시장 가치가 $1.5여야 함을 의미합니다. (T는 행렬 전치를 나타냅니다.)

켈리 공식의 다중 포트폴리오 버전은 다음과 같습니다:

$$F = C^{-1}M \qquad (8.2)$$

각 변수의 의미를 풀어보겠습니다:

- **$F$** = 각 포트폴리오에 적용할 최적 레버리지 벡터
- **$C$** = 포트폴리오 수익률의 **공분산 행렬(covariance matrix)**. 각 포트폴리오 수익률 간의 관계를 담고 있습니다.
- **$C^{-1}$** = 공분산 행렬의 역행렬
- **$M$** = 이러한 포트폴리오의 **평균 초과 수익률** 벡터

*Quantitative Trading*에 이 공식을 사용하는 방법에 대한 광범위한 예제가 있습니다.

### 최대 레버리지 제약이 있을 때는?

실전에서는 브로커가 **총 그로스 레버리지(gross leverage)**에 제한을 둡니다.

> **그로스 레버리지(gross leverage)**: 자본으로 나눈 롱과 숏 시장 가치의 **절대 합**입니다. 순(net) 레버리지와 다릅니다! 예를 들어 $100 자본으로 $200 롱, $150 숏이면, 순 레버리지는 0.5이지만 그로스 레버리지는 3.5입니다.

브로커가 총 그로스 레버리지 $\sum_{i=1}^{n} |F_{i}|$보다 작은 최대 레버리지 $F_{max}$를 설정했다면 어떻게 해야 할까요?

일반적인 권장 사항은 총 그로스 레버리지가 $F_{max}$와 같아지도록 모든 $F_{i}$에 $F_{max}/\sum_{i=1}^{n} |F_{i}|$ 비율을 곱하는 것입니다. 쉽게 말해, **모든 전략의 레버리지를 같은 비율로 줄이는 것**이죠.

그러나 이 접근법의 문제는 복리 성장률이 이 최대 레버리지 제약 하에서 **더 이상 최적이 아니라는 것**입니다. 예제 8.2가 이를 증명합니다.

### 예제 8.2: 최대 레버리지 제약 하에서의 최적 자본 배분

**문제 설정:**

여러 포트폴리오나 전략이 있을 때, 켈리 공식은 식 8.2에 의해 결정된 레버리지 $F_i$로 각 포트폴리오 $i$에 투자해야 한다고 합니다. 그러나 종종 이렇게 계산된 총 그로스 레버리지 $\sum_{i}^{n} |F_i|$는 브로커나 리스크 매니저가 부과한 최대 레버리지 $F_{max}$를 초과합니다. 이 제약이 있으면, 모든 $F_i$에 $F_{max}/\sum_{i}^{n} |F_i|$ 비율을 곱하는 것이 종종 최적이 아닙니다.

**구체적 예시:**

두 개의 전략, 1과 2가 있다고 가정합시다.

| | 전략 1 | 전략 2 |
|---|--------|--------|
| 연간화 평균 초과 수익률 | 30% | 60% |
| 연간화 변동성 | 26% | 35% |
| 켈리 레버리지 | 4.4 | 4.9 |

수익률 분포가 가우시안이고 두 전략의 수익률 사이에 **상관관계가 없다고** 가정합니다. 총 그로스 레버리지는 **9.3** (= 4.4 + 4.9)입니다.

**제약 없는 최적 성장률:**

연간화된 복리 성장률은 Thorp(1997)의 공식에 의해:

$$g = F^{T}CF/2 = 2.1 \qquad (8.3)$$

여기서 무위험 이자율이 0이라고 가정했습니다. 연간 210%의 복리 성장률입니다!

**제약 적용 — 브로커가 최대 레버리지 2만 허용할 때:**

비례적으로 줄이면, 전략의 레버리지는 각각 **0.95**와 **1.05**로 줄여야 합니다. 성장률은 이제 다음과 같이 감소합니다:

$$g = \sum_{i=1}^{2} (F_i M_i - F_i^2 s_i^2 / 2) = 0.82 \qquad (8.4)$$

(참고: 식 8.3의 *g*는 사용된 레버리지가 최적일 때만 적용됩니다.)

**하지만 과연 이것이 정말 최적일까?**

$F_1$을 $F_{max} - F_2$로 설정하고, 허용 범위 0에서 $F_{max}$까지 $F_2$의 함수로 $g$를 그려봅니다.

![](_page_5_Figure_6.jpeg)

**그림 8.1** 제약된 성장률 $g$의 $F_2$ 함수

결과는 놀랍습니다! 성장률이 **$F_2 = F_{max} = 2$일 때 최적화**됩니다. 즉, **전략 2에 모든 구매력을 몰아넣는 것**이 최적입니다! 최적화된 $g$는 **0.96**으로, 비례 배분의 0.82보다 **17% 높습니다**.

**핵심 교훈:** 매우 다른 독립적인 성장률을 가진 두 개 이상의 전략이 있고, 켈리 레버리지보다 훨씬 낮은 최대 레버리지 제약이 있을 때, **가장 높은 성장률을 가진 전략에 모든 구매력을 집중하는 것이 종종 최적**입니다. "계란을 한 바구니에 담지 마라"는 격언이 항상 옳지는 않다는 뜻입니다!

---

## 시뮬레이션된 수익률을 사용한 기대 성장률 최적화 — 현실의 팻 테일에 대처하기

### 왜 가우시안만으로는 부족한가?

가우시안 가정을 완화하고 **팻 테일(fat tails)**을 고려하기 위해 수익률 분포에 다른 분석적 형태(예: 스튜던트 t)를 대체하면, 여전히 Thorp의 논문의 유도를 따라 다른 최적 레버리지에 도달할 수 있지만, 공식은 식 8.1만큼 간단하지 않을 것입니다.

> **팻 테일(fat tail, 두꺼운 꼬리)**: 정규분포에서 예상되는 것보다 극단적인 사건이 훨씬 자주 발생하는 현상입니다. 주식 시장에서 "100년에 한 번" 올 것 같은 폭락이 10년에 한 번꼴로 오는 이유가 바로 이것입니다. 종 모양의 정규분포 그래프에서 양쪽 꼬리가 더 "두툼하게" 생겼다고 해서 팻 테일이라고 부릅니다.

파레토-레비 분포와 달리 분포가 유한한 수의 모멘트를 가지는 한 분석적 해를 구할 수 있지만, 일부 분포의 경우 분석적 답에 도달하는 것조차 불가능할 수 있습니다. 이것이 바로 **몬테카를로 시뮬레이션(Monte Carlo simulation)**이 도움이 될 수 있는 부분입니다. 몬테카를로 시뮬레이션이란 무작위 수를 대량으로 생성하여 복잡한 문제를 "실험적으로" 푸는 방법입니다. 마치 주사위를 백만 번 던져서 확률을 직접 측정하는 것과 같죠!

### 기대 성장률 공식

레버리지 *f*의 함수로서 복리 성장률의 기대값은 (단순화를 위해 무위험 이자율이 0이라고 가정):

$$g(f) = \langle \log(1 + fR) \rangle \qquad (8.5)$$

이 공식의 각 부분을 풀어보겠습니다:

- **$g(f)$** = 레버리지 $f$를 사용했을 때의 기대 복리 성장률
- **$\langle \cdots \rangle$** = $R$의 일부 확률 분포에 기반한 **무작위 샘플링에 대한 평균**을 나타냅니다. 즉 "수많은 시뮬레이션 결과의 평균"입니다.
- **$R$** = 전략의 레버리지가 적용되지 않은 **바(bar)당 수익률** $R(t)$. 시장 가격이 아닌 전략 자체의 수익률입니다.
- **$\log(1 + fR)$** = 레버리지를 적용한 후의 복리 수익률. 왜 로그를 쓰나요? 복리 효과를 수학적으로 깔끔하게 표현하기 위해서입니다. $\log$를 사용하면 곱하기가 더하기로 변환되어 계산이 훨씬 편해집니다.

일별 바를 사용하는 것이 일반적이지만, 바는 원하는 대로 길거나 짧을 수 있습니다.

이 확률 분포가 가우시안이면, $g(f)$는 분석적으로 $g(f) = fm - f^2 s^2/2$로 줄일 수 있으며, 이는 단일 전략 경우의 식 8.4와 동일합니다. 그리고 $g(f)$의 최댓값은 $g(f)$를 $f$에 대해 미분하고 0으로 설정하여 분석적으로 결정할 수 있고, 이것은 식 8.1의 켈리 공식을 재현합니다. 또한 최대 성장률도 식 8.3에서 나타난 값을 재현합니다. **그러나 우리의 관심사는 비가우시안 $R$ 분포를 사용하여 식 8.5를 계산하는 것입니다.**

### 피어슨 시스템 — 분포의 "만능 열쇠"

$R$의 진정한 분포를 알지 못하지만, **피어슨 시스템(Pearson system)**을 사용하여 모델링할 수 있습니다 ([www.mathworks.com/help/toolbox/stats/br5k833-1.html](http://www.mathworks.com/help/toolbox/stats/br5k833-1.html) 또는 [mathworld.wolfram.com/PearsonSystem.html](http://mathworld.wolfram.com/PearsonSystem.html) 참조).

> **피어슨 시스템(Pearson system)**: $R$의 경험적 분포의 **평균, 표준편차, 왜도, 첨도** — 이 네 가지 통계량만을 입력으로 받아, 가우시안, 베타, 감마, 스튜던트 t 등을 포함하는 **7가지 확률 분포 중 가장 적합한 하나**로 자동 매핑하는 시스템입니다. 마치 증상 네 가지를 입력하면 가장 가능성 높은 진단을 내려주는 AI 의사 같은 것이죠!

물론, 이것들이 가장 일반적인 분포는 아닙니다. 경험적 분포는 피어슨 시스템으로 포착되지 않는 0이 아닌 **고차 모멘트**를 가질 수 있으며, 실제로 파레토-레비 분포의 경우처럼 무한한 고차 모멘트를 가질 수 있습니다. 그러나 모든 고차 모멘트를 포착하려면 보통 이용 가능한 제한된 양의 경험적 데이터로 인해 **데이터 스누핑 편향**이 발생합니다. 따라서 모든 실용적인 목적을 위해 몬테카를로 샘플링에 피어슨 시스템을 사용합니다.

### 실전 적용: 평균 회귀 전략 예제

예제 5.1에서 설명한 평균 회귀 전략을 사용하여 이 몬테카를로 기법을 설명합니다.

**1단계: 켈리 레버리지 계산 (기준점 설정)**

먼저, 테스트 세트의 일별 수익률을 사용하여 켈리 레버리지가 **18.4**임을 쉽게 계산할 수 있습니다. 이 숫자를 몬테카를로 결과와 비교할 기준점으로 기억해 두세요.

**2단계: 피어슨 시스템으로 시뮬레이션된 수익률 생성**

이러한 일별 수익률의 처음 네 모멘트를 사용하여 피어슨 시스템을 구성하고 이 시스템에서 **100,000개의 무작위 수익률**을 생성합니다. MATLAB Statistics Toolbox의 *pearsrnd* 함수를 사용할 수 있습니다. (완전한 코드는 *monteCarloOptimLeverage.m*에 있습니다.)

**BOX 8.1:** 전략 일별 수익률이 Nx1 배열 `ret`에 포함되어 있다고 가정합니다. `ret`의 처음 네 모멘트를 사용하여 피어슨 시스템 분포를 생성하며, 이로부터 임의 개수의 시뮬레이션된 수익률 `ret_sim`을 생성할 수 있습니다.

```matlab
moments={mean(ret), std(ret), skewness(ret), kurtosis(ret)};
[ret_sim, type]=pearsrnd(moments{:}, 100000, 1);
```

코드에서 `ret`은 전략 백테스트의 일별 수익률을 포함하고, `ret_sim`은 `ret`과 동일한 네 모멘트를 가진 100,000개의 무작위 생성된 일별 수익률입니다. `pearsrnd` 함수는 또한 우리 데이터에 가장 적합한 분포 유형을 나타내는 `type`을 반환합니다. 이 예제에서 `type`은 **4**로, 분포가 스튜던트 t 같은 표준 분포가 아님을 나타냅니다. (그러나 이름이 있는지 여부는 전혀 중요하지 않습니다.)

**3단계: 성장률 함수 정의**

이제 `ret_sim`을 사용하여 $g(f)$의 평균을 계산할 수 있습니다. $g(f)$는 레버리지 $f$와 수익률 시리즈 $R$을 입력으로 하는 인라인 함수입니다.

**BOX 8.2:** 레버리지 $f$와 바당 수익률 $R$에 기반한 복리 성장률을 계산하는 인라인 함수.

```matlab
g=inline('sum(log(1+f*R))/length(R)', 'f', 'R');
```

**4단계: 최적 레버리지 탐색**

$f = 0$에서 $f = 23$까지 $g(f)$를 그려보면 $g(f)$가 실제로 **19 근처** 어딘가에서 최대값을 가짐을 알 수 있습니다 (그림 8.2 참조).

![](_page_9_Figure_2.jpeg)

**그림 8.2** $f$의 함수로서 기대 성장률 $g$.

MATLAB Optimization Toolbox의 `fminbnd` 함수를 사용한 수치 최적화는 최적 $f$가 **19**임을 제공하며, 이는 켈리의 최적 $f$ 18.4와 **놀랍도록 가깝습니다!**

**BOX 8.3:** 레버리지 $f$와 시뮬레이션된 수익률 `ret_sim`에 기반한 성장률의 음수의 최소값 찾기 (양수 성장률의 최대값을 찾는 것과 동일).

```matlab
minusGsim=@(f)-g(f, ret_sim);
optimalF=fminbnd(minusGsim, 0, 24);
```

> **참고:** $g$를 최대화하는 대신 $-g$를 최소화한 유일한 이유는 MATLAB에 `fmaxbnd` 함수가 없기 때문입니다. 최소화 함수에 음수를 씌워 최대화 문제로 변환한 것이죠!

물론, 다른 무작위 시드와 따라서 다른 시뮬레이션된 수익률 시리즈로 이 프로그램을 실행하면 최적 $f$에 대해 다소 다른 값을 찾겠지만, 이상적으로는 크게 다르지 않을 것입니다.

### 파산 경계의 발견 — 레버리지의 양날의 검

이 몬테카를로 최적화를 실행하면서 또 다른 흥미로운 결과가 있습니다. $f$를 **31**로 시도하면 성장률이 **-1, 즉 파산**임을 알 수 있습니다. 왜일까요?

기간당 가장 음수인 수익률이 **-0.0331**이므로, $1 / 0.0331 = 30.2$보다 높은 레버리지는 해당 기간 동안 $1 + f \times (-0.0331) < 0$이 되어 **전체 손실(그 이상)**을 초래합니다. 한 번이라도 자산이 0 이하로 떨어지면, $\log(1 + fR) = -\infty$가 되어 전체 성장률이 $-\infty$로 곤두박질칩니다. 이것이 레버리지의 **양날의 검** 특성을 극명하게 보여줍니다. 지렛대를 너무 세게 밀면 자기 자신이 깔려버리는 것이죠!

---

## 역사적 성장률 최적화 — 실제 데이터로 직접 최적화하기

### 왜 이것이 중요한가?

이전 섹션에서는 분석적 수익률 확률 분포를 사용하여 성장률의 기대값을 최적화했습니다. 하지만 **"왜 굳이 시뮬레이션을 돌리나? 실제 데이터가 있는데?"**라는 자연스러운 질문이 나옵니다.

물론 레버리지에 대해 **백테스트의 역사적 성장률을 직접 최적화**할 수 있습니다. 확률 분포에 대한 가정이 필요 없고, 실제로 발생한 수익률의 특정 실현된 세트만 필요합니다: 백테스트에서 실제로 발생한 것들 말이죠.

### 장단점

**장점:**
- 어떤 분포 가정도 필요 없습니다
- 데이터에 존재하는 모든 특성(직렬 상관 등)을 자동으로 포착합니다
- 구현이 간단합니다

**단점:**
- **데이터 스누핑 편향(data-snooping bias)**을 겪습니다. 이것은 백테스트에서 파라미터 최적화의 일반적인 단점입니다. 과거 시험 문제의 답을 외워서 시험을 잘 본 것과 비슷합니다 — 새로운 문제가 나오면 틀릴 수 있죠!
- 이 특정 역사적 전략 수익률 실현에 대한 최적 레버리지는 **미래에 발생할 다른 실현에 대해서는 최적이 아닐 가능성**이 높습니다.
- 몬테카를로 최적화와 달리, 역사적 수익률은 **많은 실현에 대해 잘 작동하는 최적 레버리지를 결정하기에 불충분한 데이터**를 제공합니다.

### 실전 적용

이러한 주의 사항에도 불구하고, 백테스트 수익률에 대한 **무차별 대입(brute-force) 최적화**는 때때로 켈리 레버리지와 몬테카를로 최적화 모두에 매우 유사한 답을 제공합니다. 이전 섹션과 동일한 전략을 사용하고, 시뮬레이션된 수익률 `ret_sim` 대신 역사적 수익률 `ret`을 입력하도록 최적화 프로그램을 약간 수정하면 됩니다.

**BOX 8.4:** 레버리지 $f$와 역사적 수익률 `ret`에 기반한 성장률의 음수의 최소값 찾기.

```matlab
minusG=@(f)-g(f, ret);
optimalF=fminbnd(minusG, 0, 21);
```

결과: 최적 $f$가 **18.4**. 다시 켈리 최적 $f$와 **동일**합니다!

이 세 가지 방법(켈리, 몬테카를로, 역사적 최적화)이 모두 비슷한 답을 주었다는 것은 고무적인 결과입니다. 하지만 이것이 항상 그런 것은 아니며, 특히 수익률 분포가 정규분포에서 크게 벗어날 때는 결과가 상이할 수 있습니다.

---

## 최대 낙폭 — 절벽에서 떨어지는 깊이를 제한하라

### 왜 이것이 중요한가?

여러분이 산악 등반을 한다고 상상해 보세요. 목표는 가능한 높이 올라가는 것이지만, **절벽에서 떨어지는 깊이**에도 제한이 있어야 합니다. 10미터 안전줄이 있으면 10미터 이상은 떨어지지 않겠지만, 안전줄이 없으면... 끝까지 떨어질 수 있습니다.

> **낙폭(drawdown)**: 역사적 최고점에서 현재까지의 하락폭입니다. 계좌가 $100에서 $80으로 떨어졌다면 낙폭은 -20%입니다. **최대 낙폭(maximum drawdown)**은 전체 기간 중 가장 깊이 떨어진 폭입니다.

다른 사람의 자산을 관리하는 포트폴리오 매니저에게 장기 성장률 극대화는 유일한 목표가 아닙니다. 종종 그들의 고객(또는 고용주)은 낙폭(역사적 최고점에서 계산된 수익률)의 절대값이 **특정 최대값을 절대 초과하지 않아야 한다**고 주장할 것입니다. 즉, 최대 낙폭이 얼마가 될 수 있는지를 지시합니다. "연 수익률 50%도 좋지만, 중간에 40% 이상 빠지면 안 돼요!"라는 식이죠. 이 요구 사항은 레버리지 최적화 문제에 **추가 제약 조건**으로 변환됩니다.

### 비례 축소만으로는 부족하다

불행히도, 이 변환은 제약 없는 최적 레버리지에 허용된 최대 낙폭과 원래 제약 없는 최대 낙폭의 비율을 곱하는 것만큼 간단하지 않습니다. 구체적인 숫자로 보여드리겠습니다.

시뮬레이션된 수익률 `ret_sim`으로 기대 성장률 최적화 섹션의 예제를 사용하면:
- **제약 없는 최적 $f$ = 19.2** 사용 시 → 최대 낙폭: **-0.999** (거의 파산!)
- 리스크 매니저가 이 금액의 절반만 최대 낙폭으로 허용한다고 가정합시다.
- **$f$의 절반인 9.6** 사용 시 → 최대 낙폭: 여전히 **-0.963** (거의 차이 없음!)
- 시행착오를 통해, 최대 낙폭의 규모를 약 **-0.5**로 줄이려면 → 레버리지를 **7배로**, 즉 **약 2.7**로 낮춰야 함을 발견합니다.

(다시 말하지만, 이 모든 숫자는 정확한 시뮬레이션된 수익률 시리즈에 따라 달라지므로 정확히 재현할 수 없습니다.)

**BOX 8.5:** 동일한 시뮬레이션된 수익률 시리즈 `ret_sim`에서 다른 레버리지로 최대 낙폭을 계산하기 위해 `calculateMaxDD` 함수를 사용합니다 ([http://epchan.com/book2](http://epchan.com/book2)에서 이용 가능).

```matlab
maxDD=calculateMaxDD(cumprod(1+optimalF/7*ret_sim)-1);
```

물론 이 상한선과 같은 레버리지를 설정하면 **시뮬레이션된 낙폭이 허용된 최대값을 초과하는 것만 방지**하며, 미래의 낙폭이 그렇게 되는 것은 방지하지 않습니다. 미래의 낙폭이 이 최대값을 초과하지 않도록 보장하는 유일한 방법은 **고정 비율 보험을 사용하거나 손절매를 부과하는 것**입니다. 다음 두 섹션에서 이러한 기법을 논의할 것입니다.

### 시뮬레이션 vs. 역사적 데이터 — 무엇을 사용해야 하는가?

이 최대 낙폭 추정 방법은 백테스트에서 생성된 역사적 전략 수익률이 아니라 **시뮬레이션된 전략 수익률 시리즈**에 기반합니다. 물론 역사적 전략 수익률을 사용하여 최대 낙폭을 계산하고 이를 사용하여 최적 레버리지를 결정할 수도 있습니다. 역사적 수익률을 사용하면, 제약 없는 최적 $f$를 **1.5배만 줄이면** (13으로) 최대 낙폭을 -0.49 이하로 줄일 수 있습니다. 시뮬레이션에서 7배를 줄여야 했던 것과 비교하면 큰 차이입니다!

어떤 방법을 사용해야 할까요? 각 방법의 장단점을 표로 정리해 보겠습니다:

| | 시뮬레이션된 수익률 사용 | 역사적 수익률 사용 |
|---|---|---|
| **장점** | 훨씬 더 나은 통계적 유의성. 주요 은행이나 헤지펀드가 특정 기간 동안 특정 금액을 잃을 가능성을 결정하는 데 사용하는 **VaR(Value-at-Risk)** 방법론과 유사 | 역사적 수익률에 존재할 수 있고 미래에도 지속될 수 있는 중요한 **직렬 상관관계**를 완전히 포착. 낙폭이 백만 년이 아니라 전략의 **현실적인 수명**을 포함 |
| **단점** | 시뮬레이션에서 발생하는 최대 낙폭이 실제로 **백만 년에 한 번** 이상 발생하지 않을 정도로 드물 수 있음 (펀드 매니저들이 곤경에 처했을 때 가장 좋아하는 변명!). 직렬 상관관계를 불가피하게 놓침 — 이러한 상관관계는 현실에서 최대 낙폭을 줄일 수 있음 | **최악의 시나리오를 포착하기에 데이터가 너무 제한적** |

> **VaR(Value-at-Risk, 위험가치)**: 주요 은행이나 헤지펀드가 특정 기간 동안 특정 금액을 잃을 가능성을 결정하는 데 사용하는 방법론입니다. **최악의 시나리오 예측기**와 같은 역할을 합니다. 예를 들어 "99% 확률로 하루에 $100만 이상은 잃지 않을 것이다"라고 말해줍니다.

**좋은 타협점은 두 방법에 의해 생성된 레버리지 사이의 어딘가에 있는 레버리지일 수 있습니다.** 어느 하나에만 의존하기보다, 두 결과를 모두 참고하여 판단하는 것이 현명합니다.

---

## 고정 비율 포트폴리오 보험(CPPI) — 안전벨트와 에어백을 동시에

### 왜 이것이 중요한가?

복리 성장률을 극대화하면서 최대 낙폭을 제한하려는 것은 종종 **상충되는 목표**입니다. 빨리 달리면서 동시에 안전하고 싶다? 자동차 세계에서는 이를 해결하기 위해 고성능 브레이크 시스템, 안전벨트, 에어백 등을 동시에 장착합니다. 트레이딩 세계에서 이와 동등한 것이 바로 **고정 비율 포트폴리오 보험(CPPI, Constant Proportion Portfolio Insurance)**입니다. 두 가지 소원을 모두 충족시킬 수 있는 한 가지 방법이 있다니, 듣기만 해도 흥미롭지 않나요?

### CPPI의 작동 원리

CPPI의 아이디어는 놀라울 정도로 직관적입니다. 여러분의 전체 계좌를 **두 개의 칸**으로 나눈다고 생각해 보세요:

1. **"거래 칸"** (Trading sub-account): 여기에만 전략을 적용합니다. 이 칸이 전장에 나가는 병사입니다.
2. **"금고 칸"** (Cash reserve): 절대 건드리지 않는 안전 자금입니다. 이 칸은 후방에 있는 예비 부대입니다.

구체적으로:
- 전략의 최적 켈리 레버리지가 $f$로 결정되었다고 합시다.
- 최대 낙폭 $-D$가 허용된다고 합시다 (예: -50% = $D = 0.5$).
- 초기 총 계좌 자본의 **$D$만큼을 거래용으로** 따로 설정합니다.
- 포트폴리오 시장 가치를 결정하기 위해 이 **거래 칸에만 $f$의 레버리지**를 적용합니다.
- 계좌의 나머지 **$1 - D$는 현금**으로 보관합니다.

이렇게 하면, 거래 칸의 모든 자본을 잃더라도 총 계좌에서는 **$-D$ 이상의 낙폭을 겪지 않을 것**이라고 확신할 수 있습니다!

### CPPI의 운영 규칙

**규칙 1 — 수익이 났을 때 (총 계좌 자본이 새 최고점 도달):**
거래 전략이 수익성이 있고 총 계좌 자본이 새로운 최고점에 도달하면, 거래 칸 자본을 총 자본의 $D$가 되도록 **재설정**하고, 일부 현금을 "금고 칸"으로 다시 이동할 수 있습니다. 마치 등산에서 더 높이 올라갈 때마다 안전줄을 다시 고정하는 것과 같습니다!

**규칙 2 — 손실이 났을 때:**
현금과 거래 칸 사이에 **현금을 이체하지 않습니다**. 거래 칸이 스스로의 손실을 감당하도록 내버려 둡니다. 전장의 병사가 쓰러져도 예비 부대를 투입하지 않는 것이죠.

**규칙 3 — 거래 칸 전멸:**
손실이 계속되고 거래 칸의 모든 자본을 잃으면, 허용된 최대 낙폭 $-D$에 도달했기 때문에 **전략을 포기**해야 합니다.

이 세 번째 규칙이 CPPI의 숨겨진 보너스입니다: 낙폭을 제한하는 것 외에도, **손실 전략을 우아하고 원칙적인 방식으로 종료하는 역할**을 합니다. (더 일반적이고 덜 최적인 전략 종료 방법은 포트폴리오 매니저의 **감정적 붕괴**에 의해 주도됩니다. CPPI는 이를 미리 정해진 규칙으로 대체합니다.)

### CPPI는 단순한 레버리지 축소와 다르다

여기서 중요한 포인트가 있습니다. 이 계좌 분리로 인해 CPPI는 총 계좌 자본에서 단순히 $L = fD$의 레버리지를 사용하는 것과 **동등하지 않습니다.**

레버리지를 $fD$로 낮추더라도 **최대 낙폭이 $-D$를 초과하지 않을 것이라는 보장이 없습니다.** $-D$의 손절매를 추가로 부과하거나 낙폭이 절대 $-D$ 이하로 내려가지 않더라도, 전체 계좌에 $fD$의 레버리지를 적용하면 모든 기간의 수익률이 양수(즉, 최대 낙폭이 0)가 아닌 한 CPPI와 정확히 동일한 복리 수익률을 생성하지 않습니다.

핵심 차이는 이것입니다: **낙폭이 있는 한, CPPI는 대안보다 훨씬 빠르게 주문 규모를 줄입니다.** 거래 칸에 켈리 레버리지를 사용함으로써, 계좌가 최대 낙폭 $-D$에 접근하는 것을 **거의 불가능**하게 만듭니다. 절벽 끝에 가까워질수록 발걸음이 점점 작아지는 것과 같습니다!

### CPPI의 성과 — 수치로 확인

CPPI가 장기 성장률 측면에서 $fD$의 레버리지를 사용하는 것과 동일하다는 수학적 증명이 있는지 Chan은 확실하지 않지만, 이전 섹션의 동일한 시뮬레이션된 수익률을 사용하여 100,000일 후 CPPI의 성장률이 대안 체계와 매우 유사함을 보여줄 수 있습니다.

**100,000일 시뮬레이션 ($D = 0.5$) 결과:**

| 지표 | CPPI | 대안 ($fD$ 레버리지, 손절매 없음) |
|------|------|---------------------|
| 일별 성장률 | 0.002484 | 0.002525 |
| 최대 낙폭 | **< 0.5** (설계상 보장!) | **0.9** (고통스러운!) |

성장률은 거의 비슷하지만, 최대 낙폭에서 **엄청난 차이**가 납니다! 최적 레버리지의 절반만 사용해도 손절매 없는 대안 체계의 낙폭은 0.9인 반면, CPPI는 설계상 0.5 미만입니다. CPPI의 주요 장점은 바로 이 최대 낙폭을 볼 때만 명백합니다.

### CPPI 성장률 계산 코드

**BOX 8.6:** 수익률 시리즈가 `ret_sim`이고 최적 레버리지가 `optimalF`라고 가정하며, 둘 다 이전 계산에서 가져옵니다. 또한 허용된 최대 낙폭이 $-D = -0.5$라고 가정합니다.

```matlab
g_cppi=0;
drawdown=0;
D=0.5;
for t=1:length(ret_sim)
    g_cppi=g_cppi+log(1+ ret_sim(t)*D*optimalF*(1+drawdown));
    drawdown=min(0, (1+drawdown)*(1+ ret_sim(t))-1);
end
g_cppi=g_cppi/length(ret_sim);
```

코드를 한 줄씩 살펴보면:
- `D*optimalF*(1+drawdown)` — 핵심 부분입니다. 낙폭(`drawdown`)이 커질수록 (더 음수) `(1+drawdown)`이 작아지고, 따라서 **실효 레버리지가 자동으로 줄어듭니다**. 이것이 CPPI의 마법입니다! 절벽 끝에 가까워질수록 걸음걸이가 자동으로 작아집니다.
- `drawdown=min(0, ...)` — 낙폭을 추적합니다. 0보다 클 수 없고(그건 새 최고점이므로), 0이면 리셋됩니다.

### CPPI 사용 시 주의사항

**단일 전략에만 적용:** 이 체계는 하나의 전략만 있는 계좌에만 적용되어야 합니다. 다중 전략 계좌라면, 수익성 있는 전략이 수익성 없는 전략을 "보조"하여 낙폭이 전체 전략 슬레이트를 종료할 만큼 충분히 크지 않을 가능성이 높습니다. 손실 전략이 어느 시점에 어떻게든 회복될 것이라고 생각하지 않는 한, 이것은 분명히 이상적인 상황이 아닙니다.

**야간 갭 리스크:** CPPI를 사용하는 데 한 가지 문제가 있으며, 이는 손절매 사용과 공유하는 문제입니다 — **야간 갭 중이나 시장 거래가 중단될 때마다 큰 낙폭이 발생하는 것을 방지할 수 없습니다.** 시장이 닫혀 있는 동안에는 주문을 실행할 수 없으니까요! 예상되는 시장 마감 전에 **외가격(out-of-the-money) 옵션을 구매**하면 이 위험의 일부를 제거할 수 있습니다.

---

## 손절매 — 급브레이크를 밟아야 할 때와 밟지 말아야 할 때

### 왜 이것이 중요한가?

**손절매(stop loss)**는 트레이딩에서 가장 널리 알려진 리스크 관리 도구입니다. 마치 운전 중 위험 상황에서 급브레이크를 밟는 것과 같습니다. 그런데 — 여기서 놀라운 사실이 있습니다 — **급브레이크가 항상 최선이 아닐 수 있습니다.** 빙판길에서 급브레이크를 밟으면 오히려 더 위험해지는 것처럼, 특정 상황에서 손절매는 도움이 안 될 수 있습니다.

### 손절매의 두 가지 사용법

**사용법 1 — 포지션 수준 손절매 (일반적):**
기존 포지션의 미실현 손익이 임계값 아래로 떨어질 때마다 해당 포지션을 종료합니다. 그러나 이 포지션을 종료한 후, 나중에 **새로운 포지션에 다시 진입**할 수 있으며, 아마도 같은 방향의 포지션일 수도 있습니다. 다시 말해, 전략의 누적 손익이나 낙폭에 대해 걱정하지 않습니다.

**사용법 2 — 전략 수준 손절매 (덜 일반적):**
낙폭이 임계값 아래로 떨어질 때 **전략을 완전히 종료**합니다. 이러한 손절매 사용은 어색합니다 — 전략의 수명 동안 **한 번만 발생**할 수 있으며, 이상적으로는 절대 사용하지 않아야 합니다. 이것이 동일한 보호를 위해 손절매보다 **CPPI가 선호되는 이유**입니다.

이하의 논의는 첫 번째, 더 일반적인 손절매 사용에 관한 것입니다.

### 손절매의 한계 — 갭과 유동성 소실

손절매는 포지션을 보유하고 있는 동안 **시장이 항상 열려 있을 때만** 미실현 손익이 자체 부과한 한도를 초과하는 것을 방지할 수 있습니다. 효과적인 경우:
- 시장 마감 후 포지션을 보유하지 않거나
- 주말과 공휴일을 제외하고 전자 시장이 항상 열려 있는 **통화나 일부 선물**을 거래하는 경우

그렇지 않으면, 시장이 다시 열릴 때 가격이 "갭" 다운 또는 업되면, 손절매가 우리가 허용하는 최대 손실이 요구하는 것보다 **훨씬 나쁜 가격에 실행**될 수 있습니다.

> **갭(gap)**: 시장이 닫혀 있는 동안 가격이 점프하는 현상입니다. 어제 종가가 $100이었는데 오늘 시가가 $80이면, $20의 갭이 발생한 것입니다. 손절매가 $95에 설정되어 있어도, 실제로는 $80에서 실행됩니다.

앞서 말했듯이, 옵션 구매는 이 위험을 제거하는 데 유용하지만, 구현 비용이 비쌀 수 있고 예상되는 시장 다운타임에만 가치가 있습니다.

**극단적 상황 — 플래시 크래시:**

일부 극단적인 상황에서는 **시장이 열려 있지만** 모든 유동성 공급자가 동시에 유동성을 철회하기로 결정할 때 손절매가 무용합니다. 이것은 **2010년 5월 6일 플래시 크래시** 동안 발생했습니다. 현대의 시장 조성자는 시장 스트레스 시기에 단지 **$0.01의 호가**(악명 높은 "스텁 쿼트, stub quote")만 유지하면 되기 때문입니다 (Arnuk and Saluzzi, 2012). 이것이 불운하게도 수십억 달러 매출을 가진 회사인 Accenture에 대한 매도 스톱 주문이 그날 **주당 $0.01에 실행**된 이유입니다. 상상이 되시나요? 수십억 달러 기업의 주식이 1센트에 거래된 것입니다!

### 평균 회귀 전략과 손절매 — 모순적 관계

그러나 시장이 열려 있고 정상적인 유동성이 있더라도, **평균 회귀 전략에 손절매를 부과해야 하는지는 논쟁의 여지**가 있습니다.

언뜻 보면, 손절매는 평균 회귀의 중심 가정과 **모순되는 것처럼 보입니다.** 생각해 보세요:

1. 가격이 하락하고 매수 포지션에 진입합니다.
2. 가격이 더 하락하여 손실을 유발합니다.
3. 이 가격 시리즈의 **평균 회귀를 믿는다면**, 결국 가격이 상승할 것으로 예상해야 합니다.
4. 따라서 가격이 그렇게 낮을 때 "손절매"하고 이 포지션을 종료하는 것은 **합리적이지 않습니다!**

실제로 Chan은 손절매를 부과하여 APR이나 샤프 비율이 증가한 평균 회귀 전략을 **백테스트한 적이 없다**고 합니다.

### 그런데... 레짐 변화가 일어나면?

이 주장에는 단 하나의 문제가 있습니다: **우리가 포지션에 있는 동안 평균 회귀 모델이 영구적으로 작동을 멈추면 어떻게 되는가?**

금융에서는 물리학과 달리 **법칙이 불변하지 않습니다.** Chan이 반복해서 말했듯이, 가격 시리즈에 대해 이전에 사실이었던 것이 미래에도 사실이 아닐 수 있습니다. 따라서 평균 회귀 가격 시리즈는 **레짐 변화(regime change)**를 겪어 연장된 기간 동안, 아마도 **영원히** 추세 추종 가격 시리즈가 될 수 있습니다.

이 경우 손절매는:
- **치명적인 손실을 방지**하는 데 매우 효과적입니다.
- 100% 손실을 입기 전에 **전략을 종료해야 할 가능성을 고려할 시간**을 제공합니다.

### 생존 편향 — 숨겨진 함정

여기서 **생존 편향(survivorship bias)**이 작용하고 있습니다. 중요한 통찰이니 주의 깊게 읽어주세요!

평균 회귀에서 모멘텀으로 레짐 변화하는 이러한 "변절자" 가격 시리즈는 **백테스트에서 실패한 평균 회귀 전략**이므로, 우리의 카탈로그에 포함하지 않았기 때문에 수익성 있는 평균 회귀 전략 카탈로그에 나타나지 않을 것입니다. 우리는 성공적으로 백테스트된 전략만 봤으니까요! 따라서:

> **손절매가 항상 평균 회귀 전략의 성과를 낮춘다는 이전 주장에는 생존 편향이 작용하고 있었습니다.**

더 정확한 진술은:
- **가격이 평균 회귀 상태를 유지할 때**: 손절매가 항상 평균 회귀 전략의 성과를 낮춥니다.
- **가격이 레짐 변화를 겪고 추세를 시작할 때**: 손절매가 확실히 해당 전략의 성과를 개선합니다!

### 평균 회귀 전략에 손절매를 어떻게 설정해야 하는가?

레짐 변화와 생존 편향에 대한 이러한 고려를 감안할 때, 성공적으로 백테스트된 모든 평균 회귀 전략은 생존 편향을 겪고 손절매를 부과하면 항상 성과가 저하됩니다. 그렇다면 어떻게 해야 할까요? 이 딜레마의 해결책은 우아합니다:

**백테스트 최대 장중 낙폭보다 큰 손절매를 부과하세요!**

이렇게 하면:
- 손절매는 **백테스트 기간에 절대 발동되지 않았을 것**이고, 백테스트 성과에 영향을 미치지 않았을 것입니다.
- 그러나 미래에 **블랙 스완 이벤트가 파산으로 이어지는 것을 여전히 효과적으로 방지**할 수 있습니다.

마치 집에 화재 경보기를 설치하되, 요리할 때 울리지 않을 만큼 민감도를 적절히 조절하는 것과 같습니다!

### 모멘텀 전략과 손절매 — 자연스러운 파트너

평균 회귀 전략과 대조적으로, **모멘텀 전략은 매우 논리적이고 직관적인 방식으로 손절매의 혜택을 받습니다.**

이유는 간단합니다: 모멘텀 전략이 손실을 보고 있다면, 이는 **모멘텀이 반전되었음을 의미**합니다. 따라서 논리적으로 포지션을 종료하고 심지어 포지션을 반전시켜야 합니다. 지속적으로 업데이트되는 모멘텀 거래 신호는 사실상 **내장된 손절매** 역할을 합니다.

이것이 바로 **모멘텀 모델이 평균 회귀 모델과 같은 종류의 꼬리 위험(tail risk)을 제시하지 않는 이유**입니다. 모멘텀 전략에는 이미 "자동 급브레이크"가 장착되어 있는 셈입니다!

---

## 리스크 지표 — 노란 경고등을 읽는 법

### 왜 이것이 중요한가?

위에서 논의한 많은 리스크 관리 조치는 **반응적(reactive)**입니다: 손실을 입으면 주문 규모를 줄이거나, 최대 낙폭에 도달하면 거래를 완전히 중단합니다. 이것은 운전 중 사고가 난 *후에* 에어백이 터지는 것과 같습니다.

그러나 전략이 손실을 입을 가능성이 높은 기간을 **선제적으로(proactively) 피할 수 있다면** 훨씬 더 유리할 것입니다. 마치 도로의 노란 경고등을 보고 **미리 속도를 줄이는 것**과 같습니다. 이것이 **선행 리스크 지표(leading risk indicator)**의 역할입니다.

### 선행 vs. 동시적 리스크 지표

**선행 리스크 지표**와 더 일반적인 **리스크 지표** 사이의 핵심적 구별:

- **선행 리스크 지표**: **다음** 기간이 투자에 위험할지 **예측**할 수 있게 해줍니다. (내일 폭풍이 올 것을 미리 알려주는 기상 예보)
- **일반 리스크 지표**: 위험한 기간과 **동시적**일 뿐입니다. (지금 비가 오고 있다고 알려주는 창문 밖 풍경)

### VIX — 전략에 따라 다른 의미

> **VIX(Volatility Index, 변동성 지수)**: S&P 500 옵션의 **내재 변동성**을 나타내는 지수입니다. "공포 지수"라고도 불리며, 시장 참여자들의 두려움 수준을 측정합니다.

모든 전략에 적용 가능한 하나의 리스크 지표는 없습니다: **한 전략에 위험한 기간이 다른 전략에는 매우 수익성 높은 기간**일 수 있습니다! 이것을 두 가지 실제 예시로 보여드리겠습니다.

**예시 1: 갭 매수 주식 전략 (4장) — VIX가 "도움"이 되는 경우**

| 조건 | 연간화 평균 수익률 | 샤프 비율 |
|------|-------------------|----------|
| 전체 기간 (2006.5.11~2012.4.24) | 약 8.7% | 1.5 |
| 전날 VIX > 35인 날에만 | **17.2%** | 1.4 |

놀랍지 않나요? VIX가 높은 "위험한" 날에 수익률이 오히려 **두 배로 올랐습니다!** 분명히 이 전략은 소위 위험에서 혜택을 받습니다.

**예시 2: FSTX 시가 갭 전략 (7장) — VIX가 "경고"하는 경우**

| 조건 | 연간화 평균 수익률 | 샤프 비율 |
|------|-------------------|----------|
| 전체 기간 (2004.7.16~2012.5.17) | 약 13% | 1.4 |
| 전날 VIX > 35인 날에만 | **2.6%** | **0.16** |

여기서는 VIX가 높은 날 수익률이 **5분의 1로 급감**했고, 샤프 비율은 거의 **10분의 1**로 추락했습니다. 분명히 VIX는 다음 날 거래를 피하라고 알려줍니다.

**교훈: 같은 지표라도 전략에 따라 정반대의 의미를 가질 수 있습니다!** 하나의 만능 지표는 존재하지 않습니다.

### TED 스프레드 — 은행 부도 위험의 온도계

VIX 외에 또 다른 일반적으로 사용되는 선행 리스크 지표는 **TED 스프레드(TED spread)**입니다.

> **TED 스프레드**: **3개월 런던 은행간 금리(LIBOR)**와 **3개월 T-bill(미국 단기 국채) 금리**의 차이입니다. 은행들이 서로에게 돈을 빌려줄 때 정부에 빌려주는 것보다 얼마나 더 높은 이자를 요구하는지를 나타내며, 본질적으로 **은행 부도 위험**을 측정합니다.

2008년 신용 위기에서 TED 스프레드는 기록적인 **457 베이시스 포인트**(= 4.57%)로 상승했습니다. 평소 20-30bp 수준인 것과 비교하면 엄청난 수치입니다!

왜 TED 스프레드가 VIX보다 더 신뢰할 수 있을까요? 신용 시장은 **대형 기관 플레이어들이 지배**하므로, 아마도 그들은 소매 투자자들의 군중 심리가 가치 평가에 기여하는 주식 시장에 기반한 지표보다 **더 정보에 밝을 것**입니다.

흥미로운 사실: TED 스프레드는 Snider and Youle(2010)이 발견한 것처럼 은행들이 LIBOR 금리를 더 낮게 보이도록 **사기적으로 조작했음에도 불구하고** 유용합니다. 중요한 것은 절대적인 값이 아니라 **시간에 따른 TED 스프레드의 상대적인 값**이기 때문입니다.

### 기타 리스크 지표들

다른 시기에 리스크 지표로 사용된 다른 위험 자산들이 있지만, 이것들이 **선행 지표**인지 신중하게 테스트해야 합니다:

| 지표 | 설명 | 특이 사항 |
|------|------|----------|
| **HYG** (하이일드 채권 ETF) | 고수익(=고위험) 채권의 가격 추적 | 위험 선호도의 바로미터 |
| **MXN** (멕시코 페소) | 신흥 시장 통화 | 2011년 유럽 부채 위기 때 특히 민감. 멕시코 경제가 건전했음에도 나쁜 뉴스에 민감하게 반응. 트레이더들이 MXN을 일반적인 모든 **위험 자산의 대리(proxy)**로 사용하고 있다는 사실에 기인 |
| **ONN/OFF** (ETF) | ONN은 "리스크-온" 분위기일 때 상승하는 위험 자산 바스켓을 보유. OFF는 ONN의 거울 이미지. 따라서 OFF의 높은 값이 좋은 선행 리스크 지표일 수 있음 | 이 글을 쓰는 시점에서 약 7개월의 역사만 있어 예측 가치가 있는지 확인할 충분한 증거가 없음 |

### 주문 흐름 — 가장 빠른 경고 시스템

7장의 고빈도 거래 섹션에서 언급했듯이, 짧은 시간 척도에서 **주문 흐름(order flow)** 정보에 접근할 수 있는 사람들은 주문 흐름의 갑작스럽고 큰 변화를 감지할 수 있으며, 이는 종종 **기관 트레이더들이 중요한 정보를 입수했음**을 나타냅니다.

주문 흐름 변화의 방향은 자산 유형에 따라 다릅니다:
- **위험 자산** (주식, 원자재, 위험 통화): 큰 주문 흐름 변화는 **음수** (매도 방향)
- **저위험 자산** (미국 국채, USD, JPY, CHF): 큰 주문 흐름 변화는 **양수** (매수 방향 = 안전 자산으로 도피)

이전에 배웠듯이, 주문 흐름은 **미래 가격 변화의 예측 변수**입니다 (Lyons, 2001). 따라서 주문 흐름은 그 정보가 시장에서 더 널리 확산되고 가격이 더 많이 변하기 전에 리스크의 **단기 선행 지표**로 사용될 수 있습니다. 마치 큰 파도가 해안에 도달하기 전에 바다 깊은 곳의 센서에서 먼저 감지하는 것과 같습니다!

### 전략 특화 리스크 지표

전략에 매우 특화된 리스크 지표도 있습니다:

- **유가** → 4장에서 언급한 GLD 대 GDX 페어 트레이딩의 좋은 선행 리스크 지표
- **기타 원자재 가격** → 금과 같은 원자재 가격도 이를 생산하는 국가나 기업의 ETF 페어 트레이딩에 좋은 선행 리스크 지표일 수 있음
- **발틱 건화물 지수(Baltic Dry Index)** → 수출 지향 국가의 ETF나 통화에 대한 좋은 선행 지표일 수 있음

### 데이터 스누핑 편향 경고

선행 리스크 지표의 백테스팅에 대한 중요한 문제로 결론을 맺어야 합니다. **금융 패닉이나 위기의 발생은 상대적으로 드물기** 때문에, 지표가 유용한지 결정하려 할 때 **데이터 스누핑 편향의 희생양이 되기 매우 쉽습니다.** 5번밖에 발생하지 않은 이벤트에서 패턴을 찾았다고 해서 그것이 진짜 패턴인지 알 수 없습니다.

그리고 물론 어떤 금융 지표도 **자연재해나 다른 비금융적 재앙을 예측할 수 없습니다.** 대지진이나 팬데믹은 어떤 스프레드나 VIX로도 예측할 수 없습니다.

주문 흐름 지표가 **더 높은 빈도로 작동**하므로 이들 중 가장 유용할 수 있습니다. 더 자주 발생하는 데이터 포인트를 가지므로 통계적으로 더 신뢰할 수 있기 때문입니다.

---

## 핵심 요점 — 이 장에서 기억해야 할 것들

### 장기 성장률 극대화

- **장기적으로 순자산을 극대화**하는 것이 목표인가? 그렇다면 **하프-켈리(half-Kelly) 최적 레버리지** 사용을 고려하세요. 켈리 공식의 절반이면 파산 위험을 크게 줄이면서도 합리적인 성장률을 유지할 수 있습니다.

- **전략 수익률이 팻 테일**인가? 켈리 공식에 의존하는 대신 **몬테카를로 시뮬레이션**을 사용하여 성장률을 최적화하고 싶을 수 있습니다. 피어슨 시스템이 도와줍니다.

- **데이터 스누핑 편향**을 염두에 두고, 때때로 **백테스트 수익률의 복리 성장률에 기반하여 레버리지를 직접 최적화**할 수 있습니다.

- 낙폭이 사전 설정된 최대값을 초과하지 않도록 보장하면서도 가능한 최고의 성장률을 누리고 싶은가? **고정 비율 포트폴리오 보험(CPPI)**을 사용하세요.

### 손절매

- 손절매는 **생존 편향**으로 인해 평균 회귀 전략의 백테스트 성과를 보통 낮추지만, **블랙 스완 이벤트를 방지**할 수 있습니다.

- 평균 회귀 전략의 손절매는 **백테스트에서 절대 발동되지 않도록 설정**해야 합니다. 백테스트 최대 낙폭보다 크게 설정하세요.

- 모멘텀 전략의 손절매는 그러한 전략의 **자연스럽고 논리적인 부분**을 형성합니다. 모멘텀 반전 = 손절매 = 전략 논리.

### 리스크 지표

- 위험한 기간을 피하고 싶은가? 다음 가능한 **선행 리스크 지표** 중 하나를 고려할 수 있습니다: **VIX, TED 스프레드, HYG, ONN/OFF, MXN.**

- 선행 리스크 지표의 효능을 테스트할 때 **데이터 스누핑 편향을 주의**하세요. 위기는 드물게 발생하므로 통계적 유의성을 확보하기 어렵습니다.

- **위험 자산의 점점 더 음수가 되는 주문 흐름**은 단기 선행 리스크 지표가 될 수 있습니다. 높은 빈도로 작동하므로 가장 유용할 수 있습니다.

---

## 용어 사전 (Glossary)

| 용어 (한국어) | 영어 | 정의 |
|--------------|------|------|
| **리스크 관리** | Risk Management | 거래에서 발생할 수 있는 손실을 체계적으로 제한하고 관리하는 방법론. 자동차의 안전장치 시스템에 비유할 수 있음 |
| **레버리지** | Leverage | 자기 자본 대비 투자 규모의 배수. 지렛대처럼 작은 자본으로 큰 포지션을 취할 수 있게 해주는 양날의 검 |
| **켈리 공식** | Kelly Formula | 복리 성장률을 최대화하는 최적 베팅 비율(레버리지)을 계산하는 공식. $f = m/s^2$ |
| **하프-켈리** | Half-Kelly | 켈리 공식이 권장하는 레버리지의 절반. 과대 추정 위험을 줄이기 위해 실무에서 널리 사용 |
| **낙폭 / 최대 낙폭** | Drawdown / Maximum Drawdown | 역사적 최고점에서 현재까지의 하락폭. 절벽에서 떨어지는 깊이에 비유 |
| **손절매** | Stop Loss | 미실현 손실이 임계값에 도달하면 포지션을 자동으로 종료하는 메커니즘 |
| **CPPI** | Constant Proportion Portfolio Insurance | 계좌를 거래용과 안전 자금으로 분리하여 최대 낙폭을 보장하면서 성장률을 최적화하는 기법 |
| **VaR** | Value-at-Risk | 특정 신뢰 수준에서 특정 기간 동안 발생할 수 있는 최대 예상 손실. 최악의 시나리오 예측기 |
| **팻 테일** | Fat Tail | 정규분포 대비 극단적 사건이 더 자주 발생하는 확률 분포의 특성 |
| **피어슨 시스템** | Pearson System | 평균, 표준편차, 왜도, 첨도를 사용하여 7가지 분석적 분포 중 하나로 매핑하는 시스템 |
| **그로스 레버리지** | Gross Leverage | 자본 대비 롱과 숏 포지션의 절대값 합. 순 레버리지와 구분됨 |
| **샤프 비율** | Sharpe Ratio | 초과 수익률을 수익률의 표준편차로 나눈 값. 위험 조정 수익률의 대표적 지표 |
| **VIX** | Volatility Index | S&P 500 옵션의 내재 변동성 지수. "공포 지수"로도 불림 |
| **TED 스프레드** | TED Spread | 3개월 LIBOR와 3개월 T-bill 금리의 차이. 은행 부도 위험의 척도 |
| **주문 흐름** | Order Flow | 시장에서 매수/매도 주문의 방향과 크기. 기관 투자자의 정보를 반영하는 단기 선행 지표 |
| **손실 회피** | Loss Aversion | 이익보다 손실을 더 크게 느끼는 인간의 심리적 편향 |
| **생존 편향** | Survivorship Bias | 살아남은(성공한) 사례만 보고 결론을 내려 발생하는 통계적 편향 |
| **레짐 변화** | Regime Change | 시장의 기본 특성(평균 회귀에서 추세 추종 등)이 근본적으로 바뀌는 현상 |
| **데이터 스누핑 편향** | Data-Snooping Bias | 동일한 데이터에서 반복 최적화하여 발생하는 과적합. 백테스트의 일반적 함정 |
| **복리 성장률** | Compound Growth Rate | 이익이 재투자될 때의 성장률. 단리와 달리 "눈덩이 효과"를 반영함 |
