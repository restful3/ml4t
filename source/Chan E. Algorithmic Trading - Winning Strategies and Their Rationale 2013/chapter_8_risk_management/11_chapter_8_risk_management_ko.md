# 리스크 관리 (Risk Management)

리스크 관리는 사람마다 다른 의미를 가진다. 초보 트레이더에게 리스크 관리는 "손실 회피(loss aversion)"에 의해 주도된다: 우리는 단순히 돈을 잃는 느낌을 싫어한다. 실제로, 연구에 따르면 평균적인 인간은 1달러를 잃을 위험을 감수하기 위해 2달러를 벌 수 있는 잠재력이 필요하다고 한다. 이것이 샤프 비율(Sharpe ratio) 2가 감정적으로 그토록 매력적인 이유를 설명할 수 있다 (Kahneman, 2011). 그러나 이러한 리스크에 대한 혐오 자체는 합리적이지 않다. 우리의 목표는 장기적인 자산 성장의 극대화여야 하며, 이 목표를 방해하는 한에서만 리스크를 피해야 한다. 이 장의 리스크 관리는 이 목표에 기반한다.

리스크 관리의 핵심 개념은 레버리지(leverage)의 신중한 사용이며, 이는 켈리 공식(Kelly formula)이나 복리 성장률을 최대화하는 수치적 방법을 통해 최적화할 수 있다. 그러나 때때로 현실은 우리에게 계좌의 최대 낙폭(maximum drawdown)을 제한하도록 강요한다. 이를 달성하는 명백한 방법 중 하나는 손절매(stop loss)의 사용이지만, 이는 종종 문제가 있다. 다른 방법은 고정 비율 포트폴리오 보험(constant proportion portfolio insurance)으로, 큰 낙폭을 방지하는 것 외에도 계좌의 상승 여력을 최대화하려고 시도한다. 두 가지 모두 여기서 논의될 것이다. 마지막으로, 손실 위험이 높은 시기에는 거래를 완전히 피하는 것이 현명할 수 있다. 특정 선행 리스크 지표의 사용이 효과적인 손실 회피 기법인지 조사할 것이다.

## 최적 레버리지 (Optimal Leverage)

레버리지를 사용할 때 신중해야 한다고 말하기는 쉽지만, 특정 전략이나 포트폴리오에 대해 무엇이 신중하거나 최적의 레버리지를 구성하는지 결정하는 것은 훨씬 어렵다. 왜냐하면 명백히, 레버리지를 0으로 설정하면 어떤 위험도 감수하지 않지만 어떤 수익도 창출하지 못하기 때문이다.

일부 포트폴리오 매니저들, 특히 자신의 돈을 관리하고 자기 자신 외에는 누구에게도 책임을 지지 않는 사람들에게, 거래의 유일한 목표는 장기적으로 순자산을 극대화하는 것이다. 그들은 낙폭이나 수익률의 변동성에 신경 쓰지 않는다. 따라서 그들에게 최적의 레버리지는 순자산 또는 동등하게 복리 성장률을 극대화할 수 있는 것을 의미한다.

여기서 복리 성장률을 최대화하는 최적 레버리지를 계산하는 세 가지 방법을 논의할 것이다. 각 방법은 고유한 가정과 단점이 있으며, 어떤 방법을 채택해야 하는지에 대해 불가지론적 입장을 유지하려 한다. 그러나 모든 경우에서, 시장 수익률의 미래 확률 분포가 과거와 동일하다는 가정을 해야 한다. 이것은 보통 잘못된 가정이지만, 이것이 정량적 모델이 할 수 있는 최선이다. 더욱 제한적으로, 많은 리스크 관리 기법들은 전략 자체의 수익률 확률 분포가 과거와 동일하다고 추가로 가정한다. 그리고 마지막으로, 가장 제한적인 가정은 전략의 수익률 확률 분포가 가우시안(정규분포)이라고 가정하는 것이다. 수학적 모델링에서 흔히 그렇듯이, 가장 제한적인 가정이 가장 우아하고 간단한 해결책을 제공하므로, 가우시안 가정 하의 켈리 공식부터 이 조사를 시작하겠다.

특정 레버리지를 사용한 계좌의 최대 낙폭이 -100%라면, 복리 성장률도 -100%가 되므로 이 레버리지는 최적이 될 수 없다. 따라서 최적 레버리지는 역사상 어떤 시점에서도 파산(자산이 0에 도달)하지 않아야 함을 의미하며, 이는 상당히 자명하다! 그러나 때때로 우리의 리스크 매니저(독립 트레이더에게는 배우자일 수도 있다)는 우리에게 1보다 훨씬 작은 규모의 낙폭만 허용된다고 말한다. 이 경우, 허용된 최대 낙폭은 레버리지 최적화 문제에서 추가 제약 조건을 형성한다.

최적 레버리지가 어떻게 결정되든, 하나의 중심 주제는 레버리지가 일정하게 유지되어야 한다는 것이다. 이것은 최대 낙폭 제약이 있든 없든 성장률을 최적화하는 데 필요하다. 일정한 레버리지를 유지하는 것이 다소 평범하게 들릴 수 있지만, 실행에 옮길 때는 직관에 반할 수 있다. 예를 들어, 주식 매수 포트폴리오를 보유하고 있고 지난 거래 기간에 손익(P&L)이 양수였다면, 일정한 레버리지 요구 사항은 이 기간에 더 많은 주식을 매수하도록 강요한다.

### 예제 8.1: 일정 레버리지 요구 사항의 함의

이 장에서 설명하는 레버리지 최적화의 모든 방법에 대한 중심 요구 사항은 레버리지가 항상 일정하게 유지되어야 한다는 것이다. 이것은 직관에 반하는 결과를 초래할 수 있다.

계좌에 $100,000의 자본으로 시작했고, 전략의 최적 레버리지가 5로 결정되었다면, 시장 가치가 $500,000인 포트폴리오를 보유해야 한다.

그러나 하루에 $10,000를 잃어서 자본이 $90,000로 줄고, 포트폴리오 시장 가치가 $490,000가 되었다면, 업데이트된 시장 가치가 5 × $90,000 = $450,000이 되도록 포트폴리오에서 추가로 $40,000를 청산해야 한다. 이러한 손실 상태에서의 매도는 일부 사람들을 불편하게 만들 수 있지만, 이것은 많은 리스크 관리 체계의 필수적인 부분이다.

그 다음 날 $20,000를 벌었다고 가정하자. 포트폴리오 시장 가치는 얼마여야 하는가? 그리고 그 시장 가치를 달성하기 위해 무엇을 해야 하는가?

새로운 포트폴리오 시장 가치는 5 × ($90,000 + $20,000) = $550,000이어야 한다. 현재 포트폴리오 시장 가치가 $450,000 + $20,000 = $470,000이므로, 이는 포트폴리오에 $80,000 상당의 (매수 또는 공매도) 증권을 추가해야 함을 의미한다. 바라건대, 브로커가 이 모든 추가 증권을 구매할 현금을 빌려줄 것이다!

그러나 지난 기간에 P&L이 음수였다면, 손실 상태에서 주식을 매도하도록 강요한다. 예제 8.1이 이를 설명한다.

많은 분석가들은 리스크 관리 기법의 이러한 "손실 상태에서의 매도" 특성이 금융 위기 시 전염을 일으킨다고 믿는다. (특히 이것은 2007년 8월 퀀트 펀드 붕괴의 원인으로 인용되었다; Khandani and Lo, 2007 참조). 이는 종종 많은 펀드들이 포트폴리오에서 유사한 포지션을 보유하고 있기 때문이다. 한 펀드가 아마도 관련 없는 전략으로 인해 손실을 입으면, 일정 레버리지 요구 사항으로 인해 모든 포트폴리오에서 포지션을 청산하기 쉬우며, 이는 해당 포지션을 보유한 모든 다른 펀드에 손실을 야기한다. 손실은 이 모든 다른 펀드들도 포지션을 청산하도록 강요하여 모두의 손실을 악화시킨다: 악순환이다. 이것을 공유지의 비극으로 생각할 수 있다: 한 펀드의 자기 보존("리스크 관리")이 모두에게 재앙을 초래할 수 있다.

## 켈리 공식 (Kelly Formula)

수익률의 확률 분포가 가우시안이라고 가정하면, 켈리 공식은 최적 레버리지 *f*에 대한 매우 간단한 답을 제공한다:

$$f = m / s^2 \qquad (8.1)$$

여기서 *m*은 평균 초과 수익률이고, *s*²는 초과 수익률의 분산이다.

이 공식에 대한 가장 좋은 설명 중 하나는 Edward Thorp(1997)의 논문에서 찾을 수 있으며, 나도 *Quantitative Trading* (Chan, 2009)에서 전체 한 장을 이에 할애했다. 가우시안 가정이 좋은 근사라면, 켈리 레버리지 *f*가 모든 이익이 재투자된다고 가정할 때 자산의 가장 높은 복리 성장률을 생성할 것임을 증명할 수 있다. 그러나 가우시안 가정이 실제로 유효하더라도, 초과 수익률의 "진정한" 평균과 분산이 무엇인지 추정하려 할 때 필연적으로 추정 오류가 발생할 것이다. 그리고 아무리 좋은 추정 방법을 사용해도, 미래의 평균과 분산이 역사적인 것과 동일할 것이라는 보장은 없다. 과대 추정된 평균이나 과소 추정된 분산을 사용하는 결과는 심각하다: 두 경우 모두 과대 추정된 최적 레버리지로 이어지고, 이 과대 추정된 레버리지가 충분히 높으면 결국 파산으로 이어진다: 자산이 0이 된다. 그러나 과소 추정된 레버리지를 사용하는 결과는 단지 최적이 아닌 복리 성장률일 뿐이다. 많은 트레이더들은 정당하게 후자의 시나리오를 선호하며, 켈리 공식이 권장하는 것의 절반에 해당하는 레버리지를 일상적으로 배치한다: 소위 하프-켈리(half-Kelly) 레버리지이다.

켈리의 최적 레버리지를 사용한 나의 실제 경험은 그것이 반드시 사용해야 하는 레버리지가 아니라 상한선으로 보는 것이 가장 좋다는 것이다. 종종 백테스트(또는 짧은 기간의 워크포워드 테스트)에서 주어진 켈리 레버리지는 너무 높아서 브로커가 허용하는 최대 레버리지를 훨씬 초과한다. 다른 경우에는 켈리 레버리지가 비가우시안 수익률 분포로 인해 백테스트에서조차 파산시켰을 것이다. 다시 말해, 백테스트의 최대 낙폭이 켈리 레버리지를 사용하면 -1이 되어, 더 현실적인 비가우시안 분포를 사용하여 성장률을 수치적으로 최적화하는 것이 더 실용적일 수 있음을 의미한다. 대안으로, 경험적, 역사적 수익률에 대해 최적화할 수도 있다. 이 두 방법은 다음 섹션에서 논의될 것이다.

그러나 켈리 최적 레버리지를 상한선으로만 사용하는 것도 때때로 흥미로운 통찰을 제공할 수 있다. 예를 들어, 나는 한 번 Russell 1000과 2000 지수 모두 켈리 레버리지가 약 1.8이라고 계산했다. 그러나 상장지수펀드(ETF) 후원사 Direxion은 이러한 지수를 추적하는 트리플 레버리지 ETF인 BGU와 TNA를 마케팅해 왔다. 설계상 레버리지가 3이다. 분명히 이러한 ETF의 순자산가치(NAV)가 0이 될 실제 위험이 있다. 마찬가지로 분명히, 후원사 자신도 쉽게 동의하듯이, 어떤 투자자도 이러한 ETF를 매수하고 보유해서는 안 된다.

켈리 공식의 최적 레버리지 설정 외에 또 다른 용도가 있다: 다른 포트폴리오나 전략에 구매력을 최적으로 배분하는 방법도 알려준다. F를 공통 자본 풀에 기반하여 다른 포트폴리오에 적용해야 하는 최적 레버리지의 열 벡터로 표시하자. (예를 들어, $1의 자본이 있다면, $F = [3.2 \ 1.5]^T$는 첫 번째 포트폴리오의 시장 가치가 $3.2이고 두 번째 포트폴리오의 시장 가치가 $1.5여야 함을 의미한다. T는 행렬 전치를 나타낸다.) 켈리 공식은 다음과 같이 말한다:

$$F = C^{-1}M \qquad (8.2)$$

여기서 C는 포트폴리오 수익률의 공분산 행렬이고 M은 이러한 포트폴리오의 평균 초과 수익률이다.

*Quantitative Trading*에 이 공식을 사용하는 방법에 대한 광범위한 예제가 있다. 그러나 브로커가 총 그로스 레버리지 $\sum_{i=1}^{n} |F_{i}|$보다 작은 최대 레버리지 $F_{max}$를 설정했다면 어떻게 해야 하는가? (우리는 자본으로 나눈 롱과 숏 시장 가치의 순액인 순 레버리지가 아니라, 자본으로 나눈 롱과 숏 시장 가치의 절대 합과 같은 그로스 레버리지에 관심이 있다.) 일반적인 권장 사항은 총 그로스 레버리지가 $F_{max}$와 같아지도록 모든 $F_{i}$에 $F_{max}/\sum_{i=1}^{n} |F_{i}|$ 비율을 곱하는 것이다. 이 접근법의 문제는 복리 성장률이 이 최대 레버리지 제약 하에서 더 이상 최적이 아니라는 것이다. 나는 이를 보여주기 위해 예제 8.2를 구성했다. 그 예제의 결론은 $F_{max}$가 $\sum_{i=1}^{n} |F_{i}|$보다 훨씬 작을 때, 가장 높은 평균 초과 수익률을 가진 포트폴리오나 전략에 대부분 또는 모든 구매력을 투자하는 것이 (성장률 극대화 측면에서) 종종 최적이라는 것이다.

## 시뮬레이션된 수익률을 사용한 기대 성장률 최적화

가우시안 가정을 완화하고 팻 테일(fat tails)을 고려하기 위해 수익률 분포에 다른 분석적 형태(예: 스튜던트 t)를 대체하면, 여전히 Thorp의

### 예제 8.2: 최대 레버리지 제약 하에서의 최적 자본 배분

여러 포트폴리오나 전략이 있을 때, 켈리 공식은 식 8.2에 의해 결정된 레버리지 $F_i$로 각 포트폴리오 i에 투자해야 한다고 말한다. 그러나 종종 이렇게 계산된 총 그로스 레버리지 $\sum_{i}^{n} |F_i|$는 브로커나 리스크 매니저가 우리에게 부과한 최대 레버리지 $F_{max}$를 초과한다. 이 제약이 있으면, 모든 $F_i$에 $F_{max}/\sum_{i}^{n} |F_i|$ 비율을 곱하는 것이 종종 최적이 아니며, 이를 여기서 보여주겠다.

두 개의 전략, 1과 2가 있다고 가정하자. 전략 1은 연간화된 평균 초과 수익률과 변동성이 각각 30%와 26%이다. 전략 2는 연간화된 평균 초과 수익률과 변동성이 각각 60%와 35%이다. 또한 수익률 분포가 가우시안이고 1과 2의 수익률 사이에 상관관계가 없다고 가정하자. 그러면 켈리 레버리지는 각각 4.4와 4.9이며, 총 그로스 레버리지는 9.3이다. 연간화된 복리 성장률은 (Thorp, 1997):

$$g = F^{T}CF/2 = 2.1 \qquad (8.3)$$

여기서 무위험 이자율이 0이라고 가정했다. 이제 브로커가 최대 레버리지 2만 허용한다고 가정하자.

![](_page_5_Figure_6.jpeg)

**그림 8.1** 제약된 성장률 g의 $F_2$ 함수

그러면 전략의 레버리지는 각각 0.95와 1.05로 줄여야 한다. 성장률은 이제 다음과 같이 감소한다:

$$g = \sum_{i=1}^{2} (F_i M_i - F_i^2 s_i^2 / 2) = 0.82 \qquad (8.4)$$

(식 8.3의 *g*는 사용된 레버리지가 최적일 때만 적용된다.)

그러나 이러한 레버리지가 최대 레버리지 제약 하에서 정말로 최대 *g*를 생성하는가? *F*₁을 *Fmax* − *F*₂로 설정하고, 허용 범위 0에서 *Fmax*까지 *F*₂의 함수로 *g*를 그려보면 알 수 있다.

성장률이 *F*₂ = *Fmax* = 2일 때 최적화됨이 명백하다. 최적화된 *g*는 0.96으로, 식 8.4에서 주어진 0.82보다 높다. 이는 매우 다른 독립적인 성장률을 가진 두 개 이상의 전략이 있고, 켈리 레버리지보다 훨씬 낮은 최대 레버리지 제약이 있을 때, 가장 높은 성장률을 가진 전략에 모든 구매력을 적용하는 것이 종종 최적임을 보여준다.

논문의 유도를 따라 다른 최적 레버리지에 도달할 수 있지만, 공식은 식 8.1만큼 간단하지 않을 것이다. (이것은 파레토-레비 분포와 달리 분포가 유한한 수의 모멘트를 가지는 한 사실이다.) 일부 분포의 경우, 분석적 답에 도달하는 것조차 불가능할 수 있다. 이것이 몬테카를로 시뮬레이션이 도움이 될 수 있는 부분이다.

레버리지 *f*의 함수로서 복리 성장률의 기대값은 (단순화를 위해 무위험 이자율이 0이라고 가정):

$$g(f) = \langle \log(1 + fR) \rangle \qquad (8.5)$$

여기서 〈…〉는 *R*의 일부 확률 분포에 기반한 전략(시장 가격이 아닌)의 레버리지가 적용되지 않은 바당 수익률 *R*(*t*)의 무작위 샘플링에 대한 평균을 나타낸다. (우리는 일반적으로 *R*(*t*)에 일별 바를 사용하지만, 바는 원하는 대로 길거나 짧을 수 있다.) 이 확률 분포가 가우시안이면, *g*(*f*)는 분석적으로 *g*(*f*) = *fm* − *f*²*m*²/2로 줄일 수 있으며, 이는 단일 전략 경우의 식 8.4와 동일하다. 또한 *g*(*f*)의 최댓값은 물론 *g*(*f*)를 *f*에 대해 미분하고 0으로 설정하여 분석적으로 결정할 수 있다. 이것은 식 8.1의 켈리 공식을 재현하고 단일 전략 경우 식 8.3에서 나타난 최대 성장률을 재현할 것이다. 그러나 이것은 여기서 우리의 관심사가 아니다. 비가우시안 *R* 분포를 사용하여 식 8.5를 계산하고자 한다.

*R*의 진정한 분포를 알지 못하지만, 소위 피어슨 시스템(Pearson system)을 사용하여 모델링할 수 있다 ([www.mathworks.com/help/toolbox/stats/br5k833-1.html](http://www.mathworks.com/help/toolbox/stats/br5k833-1.html) 또는 [mathworld.wolfram.com/PearsonSystem.html](http://mathworld.wolfram.com/PearsonSystem.html) 참조). 피어슨 시스템은 *R*의 경험적 분포의 평균, 표준편차, 왜도, 첨도를 입력으로 받아 가우시안, 베타, 감마, 스튜던트 t 등을 포함하는 분석적으로 표현 가능한 7가지 확률 분포 중 하나로 모델링한다. 물론, 이것들이 가장 일반적인 분포는 아니다. 경험적 분포는 피어슨 시스템으로 포착되지 않는 0이 아닌 고차 모멘트를 가질 수 있으며, 실제로 파레토-레비 분포의 경우처럼 무한한 고차 모멘트를 가질 수 있다. 그러나 모든 고차 모멘트를 포착하려면 보통 이용 가능한 제한된 양의 경험적 데이터로 인해 데이터 스누핑 편향이 발생한다. 따라서 모든 실용적인 목적을 위해 몬테카를로 샘플링에 피어슨 시스템을 사용한다.

예제 5.1에서 설명한 평균 회귀 전략을 사용하여 이 몬테카를로 기법을 설명한다. 그러나 먼저, 테스트 세트의 일별 수익률을 사용하여 켈리 레버리지가 18.4임을 쉽게 계산할 수 있다. 몬테카를로 결과와 비교할 때 이 숫자를 염두에 두어야 한다. 다음으로, 이러한 일별 수익률의 처음 네 모멘트를 사용하여 피어슨 시스템을 구성하고 이 시스템에서 100,000개의 무작위 수익률을 생성한다. 이를 위해 MATLAB Statistics Toolbox의 *pearsrnd* 함수를 사용할 수 있다. (완전한 코드는 *monteCarloOptimLeverage.m*에 있다.)

**BOX 8.1:** 전략 일별 수익률이 Nx1 배열 ret에 포함되어 있다고 가정한다. ret의 처음 네 모멘트를 사용하여 피어슨 시스템 분포를 생성하며, 이로부터 임의 개수의 시뮬레이션된 수익률 ret_sim을 생성할 수 있다.

```matlab
moments={mean(ret), std(ret), skewness(ret), kurtosis(ret)};
[ret_sim, type]=pearsrnd(moments{:}, 100000, 1);
```

코드에서 *ret*은 전략 백테스트의 일별 수익률을 포함하고, *ret_sim*은 *ret*과 동일한 네 모멘트를 가진 100,000개의 무작위 생성된 일별 수익률이다. *pearsrnd* 함수는 또한 우리 데이터에 가장 적합한 분포 유형을 나타내는 *type*을 반환한다. 이 예제에서 *type*은 4로, 분포가 스튜던트 t 같은 표준 분포가 아님을 나타낸다. (그러나 이름이 있는지 여부는 전혀 중요하지 않다.) 이제 *ret_sim*을 사용하여 *g*(*f*)의 평균을 계산할 수 있다. 우리 코드에서 *g*(*f*)는 레버리지 *f*와 수익률 시리즈 *R*을 입력으로 하는 인라인 함수이다.

**BOX 8.2:**

레버리지 f와 바당 수익률 R에 기반한 복리 성장률을 계산하는 인라인 함수.

```matlab
g=inline('sum(log(1+f*R))/length(R)', 'f', 'R');
```

*f* = 0에서 *f* = 23까지 *g*(*f*)를 그려보면 *g*(*f*)가 실제로 19 근처 어딘가에서 최대값을 가짐을 알 수 있으며 (그림 8.2 참조), MATLAB Optimization Toolbox의 *fminbnd* 함수를 사용한 수치 최적화는 최적 *f*가 19임을 제공하며, 이는 켈리의 최적 *f* 18.4와 놀랍도록 가깝다!

**BOX 8.3:** 레버리지 f와 시뮬레이션된 수익률 ret_sim에 기반한 성장률의 음수의 최소값 찾기 (양수 성장률의 최대값을 찾는 것과 동일).

```matlab
minusGsim=@(f)-g(f, ret_sim);
optimalF=fminbnd(minusGsim, 0, 24);
```

물론, 다른 무작위 시드와 따라서 다른 시뮬레이션된 수익률 시리즈로 이 프로그램을 실행하면 최적 *f*에 대해 다소 다른 값을 찾겠지만, 이상적으로는 내 값과 크게 다르지 않을 것이다. (참고로, *g*를 최대화하는 대신 −*g*를 최소화한 유일한 이유는 MATLAB에 *fmaxbnd* 함수가 없기 때문이다.)

이 몬테카를로 최적화를 실행하면서 또 다른 흥미로운 결과가 있다. *f*를 31로 시도하면 성장률이 -1, 즉 파산임을 알 수 있다. 이는 기간당 가장 음수인 수익률이 -0.0331이므로, 1 / 0.0331 = 30.2보다 높은 레버리지는 해당 기간 동안 전체 손실을 초래하기 때문이다.

## 역사적 성장률 최적화

이전 섹션에서 했던 것처럼 분석적 수익률 확률 분포를 사용하여 성장률의 기대값을 최적화하는 대신,

![](_page_9_Figure_2.jpeg)

**그림 8.2** *f*의 함수로서 기대 성장률 *g*.

물론 레버리지에 대해 백테스트의 역사적 성장률을 최적화할 수 있다. 실제로 발생한 수익률의 특정 실현된 세트만 필요하다: 백테스트에서 실제로 발생한 것. 이 방법은 백테스트에서 파라미터 최적화의 일반적인 단점인 데이터 스누핑 편향을 겪는다. 일반적으로 이 특정 역사적 전략 수익률 실현에 대한 최적 레버리지는 미래에 발생할 다른 실현에 대해서는 최적이 아닐 것이다. 몬테카를로 최적화와 달리, 역사적 수익률은 많은 실현에 대해 잘 작동하는 최적 레버리지를 결정하기에 불충분한 데이터를 제공한다.

이러한 주의 사항에도 불구하고, 백테스트 수익률에 대한 무차별 대입 최적화는 때때로 켈리 레버리지와 몬테카를로 최적화 모두에 매우 유사한 답을 제공한다. 이전 섹션과 동일한 전략을 사용하고, 시뮬레이션된 수익률 *ret_sim* 대신 역사적 수익률 *ret*을 입력하도록 최적화 프로그램을 약간 수정하면,

**BOX 8.4:**

레버리지 f와 역사적 수익률 ret에 기반한 성장률의 음수의 최소값 찾기.

```matlab
minusG=@(f)-g(f, ret);
optimalF=fminbnd(minusG, 0, 21);
```

최적 f가 18.4임을 얻으며, 이는 다시 켈리 최적 f와 동일하다.

## 최대 낙폭 (Maximum Drawdown)

다른 사람의 자산을 관리하는 포트폴리오 매니저에게 장기 성장률 극대화는 유일한 목표가 아니다. 종종 그들의 고객(또는 고용주)은 낙폭(역사적 최고점에서 계산된 수익률)의 절대값이 특정 최대값을 절대 초과하지 않아야 한다고 주장할 것이다. 즉, 최대 낙폭이 얼마가 될 수 있는지를 지시한다. 이 요구 사항은 레버리지 최적화 문제에 추가 제약 조건으로 변환된다.

불행히도, 이 변환은 제약 없는 최적 레버리지에 허용된 최대 낙폭과 원래 제약 없는 최대 낙폭의 비율을 곱하는 것만큼 간단하지 않다. 시뮬레이션된 수익률 *ret_sim*으로 기대 성장률 최적화 섹션의 예제를 사용하면, 최대 낙폭은 무서운 -0.999이다. 이것은 제약 없는 최적 *f* 19.2를 사용한 경우이다. 리스크 매니저가 이 금액의 절반만 최대 낙폭으로 허용한다고 가정하자. 최적 *f*의 절반인 9.6을 사용해도 여전히 -0.963의 최대 낙폭을 생성한다. 시행착오를 통해, 최대 낙폭의 규모를 약 0.5로 줄이려면 레버리지를 7배로, 약 2.7로 낮춰야 함을 발견한다. (다시 말하지만, 이 모든 숫자는 정확한 시뮬레이션된 수익률 시리즈에 따라 달라지므로 정확히 재현할 수 없다.)

**BOX 8.5**

동일한 시뮬레이션된 수익률 시리즈 ret_sim에서 다른 레버리지로 최대 낙폭을 계산하기 위해 내 함수 calculateMaxDD ([http://epchan.com/book2](http://epchan.com/book2)에서 이용 가능) 사용.

maxDD=calculateMaxDD(cumprod(1+optimalF/7\*ret_sim)-1);

물론 이 상한선과 같은 레버리지를 설정하면 시뮬레이션된 낙폭이 허용된 최대값을 초과하는 것만 방지하며, 미래의 낙폭이 그렇게 되는 것은 방지하지 않는다. 미래의 낙폭이 이 최대값을 초과하지 않도록 보장하는 유일한 방법은 고정 비율 보험을 사용하거나 손절매를 부과하는 것이다. 다음 두 섹션에서 이러한 기법을 논의할 것이다.

이 최대 낙폭 추정 방법은 백테스트에서 생성된 역사적 전략 수익률이 아니라 시뮬레이션된 전략 수익률 시리즈에 기반한다는 점에 주목할 가치가 있다. 물론, 역사적 전략 수익률을 사용하여 최대 낙폭을 계산하고 이를 사용하여 최적 레버리지를 결정할 수도 있다. 이 경우, 제약 없는 최적 *f*를 1.5배 (13으로)만 줄이면 최대 낙폭을 -0.49 이하로 줄일 수 있음을 발견할 것이다.

어떤 방법을 사용해야 하는가? 시뮬레이션된 수익률을 사용하는 장점은 훨씬 더 나은 통계적 유의성을 갖는다는 것이다. 이는 주요 은행이나 헤지펀드가 특정 기간 동안 특정 금액을 잃을 가능성을 결정하는 데 사용하는 VaR(Value-at-Risk) 방법론과 유사하다. 단점은 시뮬레이션에서 발생하는 최대 낙폭이 실제로 백만 년에 한 번 이상 발생하지 않을 정도로 드물 수 있다는 것이다 (펀드 매니저들이 곤경에 처했을 때 가장 좋아하는 변명). 또한 시뮬레이션된 수익률은 역사적 수익률에 존재할 수 있고 미래에도 지속될 수 있는 일부 중요한 직렬 상관관계를 불가피하게 놓친다. 이러한 상관관계는 현실 세계에서 최대 낙폭을 줄일 수 있다. 역사적 전략 수익률을 사용하는 장점은 이러한 상관관계를 완전히 포착하고, 또한 낙폭이 백만 년이 아니라 전략의 현실적인 수명을 포함한다는 것이다. 단점은 물론 최악의 시나리오를 포착하기에 데이터가 너무 제한적이라는 것이다. 좋은 타협점은 두 방법에 의해 생성된 레버리지 사이의 어딘가에 있는 레버리지일 수 있다.

## 고정 비율 포트폴리오 보험 (Constant Proportion Portfolio Insurance)

복리 성장률을 극대화하면서 최대 낙폭을 제한하려는 종종 상충되는 목표는 이미 논의되었다. 두 가지 소원을 모두 충족시킬 수 있는 한 가지 방법이 있다: 고정 비율 포트폴리오 보험(CPPI).

전략의 최적 켈리 레버리지가 *f*로 결정되었다고 가정하자. 그리고 -D의 최대 낙폭이 허용된다고 가정하자. 초기 총 계좌 자본의 D만큼을 거래용으로 따로 설정하고, 포트폴리오 시장 가치를 결정하기 위해 이 하위 계좌에 *f*의 레버리지를 적용할 수 있다. 계좌의 나머지 1 − D는 현금으로 보관된다. 그러면 이 하위 계좌의 모든 자본을 잃지 않을 것이라고, 또는 동등하게 총 계좌에서 -D 이상의 낙폭을 겪지 않을 것이라고 확신할 수 있다. 거래 전략이 수익성이 있고 총 계좌 자본이 새로운 최고점에 도달하면, 하위 계좌 자본을 총 자본의 D가 되도록 재설정하고, 일부 현금을 "현금" 계좌로 다시 이동할 수 있다. 그러나 전략이 손실을 입으면, 현금과 거래 하위 계좌 사이에 현금을 이체하지 않는다. 물론 손실이 계속되고 거래 하위 계좌의 모든 자본을 잃으면, 허용된 최대 낙폭 -D에 도달했기 때문에 전략을 포기해야 한다. 따라서 낙폭을 제한하는 것 외에도, 이 체계는 손실 전략을 우아하고 원칙적인 방식으로 종료하는 역할을 한다. (더 일반적이고 덜 최적인 전략 종료 방법은 포트폴리오 매니저의 감정적 붕괴에 의해 주도된다.)

이 계좌 분리로 인해 이 체계는 총 계좌 자본에서 단순히 *L* = *f*D의 레버리지를 사용하는 것과 동등하지 않음에 주목하라. 레버리지를 *f*D로 낮추더라도 최대 낙폭이 -D를 초과하지 않을 것이라는 보장이 없다. -D의 손절매를 추가로 부과하거나 낙폭이 절대 -D 이하로 내려가지 않더라도, 전체 계좌에 *f*D의 레버리지를 적용하면 모든 기간의 수익률이 양수(즉, 최대 낙폭이 0)가 아닌 한 CPPI와 정확히 동일한 복리 수익률을 생성하지 않는다. 낙폭이 있는 한, CPPI는 대안보다 훨씬 빠르게 주문 규모를 줄여, (하위 계좌에 켈리 레버리지를 사용함으로써) 계좌가 최대 낙폭 -D에 접근하는 것을 거의 불가능하게 만든다.

CPPI가 장기 성장률 측면에서 *f*D의 레버리지를 사용하는 것과 동일하다는 수학적 증명이 있는지 모르겠지만, 이전 섹션의 동일한 시뮬레이션된 수익률을 사용하여 100,000일 후 CPPI의 성장률이 대안 체계와 매우 유사함을 보여줄 수 있다: D = 0.5인 한 시뮬레이션에서 하루당 0.002484 대 0.002525. CPPI의 주요 장점은 최대 낙폭을 볼 때만 명백하다. 설계상 CPPI의 낙폭 규모는 0.5 미만인 반면, 최적 레버리지의 절반만 사용해도 손절매 없는 대안 체계의 낙폭은 고통스러운 0.9이다. CPPI를 사용하여 성장률을 계산하는 코드는 Box 8.6에 나와 있다.

### CPPI를 사용한 성장률 계산

**BOX 8.6:** 수익률 시리즈가 ret_sim이고 최적 레버리지가 optimalF라고 가정하며, 둘 다 이전 계산에서 가져온다. 또한 허용된 최대 낙폭이 –D = –0.5라고 가정한다.

```matlab
g_cppi=0;
drawdown=0;
D=0.5;
for t=1:length(ret_sim)
    g_cppi=g_cppi+log(1+ ret_sim(t)*D*optimalF*(1+drawdown));
    drawdown=min(0, (1+drawdown)*(1+ ret_sim(t))-1);
end
g_cppi=g_cppi/length(ret_sim);
```

이 체계는 하나의 전략만 있는 계좌에만 적용되어야 함에 주의하라. 다중 전략 계좌라면, 수익성 있는 전략이 수익성 없는 전략을 "보조"하여 낙폭이 전체 전략 슬레이트를 종료할 만큼 충분히 크지 않을 가능성이 높다. 손실 전략이 어느 시점에 어떻게든 회복될 것이라고 생각하지 않는 한, 이것은 분명히 이상적인 상황이 아니다.

CPPI를 사용하는 데 한 가지 문제가 있으며, 이는 손절매 사용과 공유하는 문제이다: 야간 갭 중이나 시장 거래가 중단될 때마다 큰 낙폭이 발생하는 것을 방지할 수 없다. 예상되는 시장 마감 전에 외가격 옵션을 구매하면 이 위험의 일부를 제거할 수 있다.

## 손절매 (Stop Loss)

손절매를 사용하는 두 가지 방법이 있다. 일반적인 사용법은 기존 포지션의 미실현 손익이 임계값 아래로 떨어질 때마다 해당 포지션을 종료하는 데 손절매를 사용하는 것이다. 그러나 이 포지션을 종료한 후, 나중에 새로운 포지션에 다시 진입할 수 있으며, 아마도 같은 방향의 포지션일 수도 있다. 다시 말해, 전략의 누적 손익이나 낙폭에 대해 걱정하지 않는다.

덜 일반적인 사용법은 낙폭이 임계값 아래로 떨어질 때 전략을 완전히 종료하는 데 손절매를 사용하는 것이다. 이러한 손절매 사용은 어색하다 - 전략의 수명 동안 한 번만 발생할 수 있으며, 이상적으로는 절대 사용하지 않아야 한다. 이것이 동일한 보호를 위해 손절매보다 CPPI가 선호되는 이유이다. 이 섹션의 나머지 부분은 첫 번째, 더 일반적인 손절매 사용에 관한 것이다.

손절매는 포지션을 보유하고 있는 동안 시장이 항상 열려 있을 때만 미실현 손익이 자체 부과한 한도를 초과하는 것을 방지할 수 있다. 예를 들어, 시장 마감 후 포지션을 보유하지 않거나 주말과 공휴일을 제외하고 전자 시장이 항상 열려 있는 통화나 일부 선물을 거래하는 경우 효과적이다. 그렇지 않으면, 시장이 다시 열릴 때 가격이 "갭" 다운 또는 업되면, 손절매가 우리가 허용하는 최대 손실이 요구하는 것보다 훨씬 나쁜 가격에 실행될 수 있다. 앞서 말했듯이, 옵션 구매는 이 위험을 제거하는 데 필요하지만, 구현 비용이 비쌀 수 있고 예상되는 시장 다운타임에만 가치가 있다.

일부 극단적인 상황에서는 시장이 열려 있지만 모든 유동성 공급자가 동시에 유동성을 철회하기로 결정할 때 손절매가 무용하다.

이것은 2010년 5월 6일 플래시 크래시 동안 발생했는데, 현대의 시장 조성자는 시장 스트레스 시기에 단지 $0.01의 호가(악명 높은 "스텁 쿼트")만 유지하면 되기 때문이다 (Arnuk and Saluzzi, 2012). 이것이 불운하게도 수십억 달러 매출을 가진 회사인 Accenture에 대한 매도 스톱 주문이 그날 주당 $0.01에 실행된 이유이다.

그러나 시장이 열려 있고 정상적인 유동성이 있더라도, 평균 회귀 전략에 손절매를 부과해야 하는지는 논쟁의 여지가 있다. 언뜻 보면, 손절매는 평균 회귀의 중심 가정과 모순되는 것처럼 보인다. 예를 들어, 가격이 하락하고 매수 포지션에 진입했는데, 가격이 더 하락하여 손실을 유발한다면, 이 가격 시리즈의 평균 회귀를 믿는다면 결국 가격이 상승할 것으로 예상해야 한다. 따라서 가격이 그렇게 낮을 때 "손절매"하고 이 포지션을 종료하는 것은 합리적이지 않다. 실제로 손절매를 부과하여 APR이나 샤프 비율이 증가한 평균 회귀 전략을 백테스트한 적이 없다.

이 주장에는 단 하나의 문제가 있다: 우리가 포지션에 있는 동안 평균 회귀 모델이 영구적으로 작동을 멈추면 어떻게 되는가? 금융에서는 물리학과 달리 법칙이 불변하지 않다. 내가 반복해서 말했듯이, 가격 시리즈에 대해 이전에 사실이었던 것이 미래에도 사실이 아닐 수 있다. 따라서 평균 회귀 가격 시리즈는 레짐 변화를 겪어 연장된 기간 동안, 아마도 영원히 추세 추종 가격 시리즈가 될 수 있다. 이 경우 손절매는 치명적인 손실을 방지하는 데 매우 효과적이며, 100% 손실을 입기 전에 전략을 종료해야 할 가능성을 고려할 시간을 제공한다. 또한 평균 회귀에서 모멘텀으로 레짐 변화하는 이러한 "변절자" 가격 시리즈는 백테스트에서 실패한 평균 회귀 전략을 우리의 카탈로그에 포함하지 않았기 때문에 수익성 있는 평균 회귀 전략 카탈로그에 나타나지 않을 것이다. 손절매가 항상 평균 회귀 전략의 성과를 낮춘다고 이전에 주장했을 때 생존 편향이 작용하고 있었다. 가격이 평균 회귀 상태를 유지할 때 손절매가 항상 평균 회귀 전략의 성과를 낮추지만, 가격이 레짐 변화를 겪고 추세를 시작할 때 해당 전략의 성과를 확실히 개선한다는 것이 더 정확하다!

레짐 변화와 생존 편향에 대한 이러한 고려를 감안할 때, 성공적으로 백테스트된 모든 평균 회귀 전략은 생존 편향을 겪고 손절매를 부과하면 항상 성과가 저하되므로 평균 회귀 전략에 손절매를 어떻게 부과해야 하는가? 분명히 백테스트 최대 장중 낙폭보다 큰 손절매를 부과해야 한다. 이 경우 손절매는 백테스트 기간에 절대 발동되지 않았을 것이고 백테스트 성과에 영향을 미치지 않았을 것이지만,

미래에 블랙 스완 이벤트가 파산으로 이어지는 것을 여전히 효과적으로 방지할 수 있다.

평균 회귀 전략과 대조적으로, 모멘텀 전략은 매우 논리적이고 직관적인 방식으로 손절매의 혜택을 받는다. 모멘텀 전략이 손실을 보고 있다면, 이는 모멘텀이 반전되었음을 의미하므로 논리적으로 포지션을 종료하고 심지어 포지션을 반전시켜야 한다. 따라서 지속적으로 업데이트되는 모멘텀 거래 신호는 사실상 손절매 역할을 한다. 이것이 모멘텀 모델이 평균 회귀 모델과 같은 종류의 꼬리 위험을 제시하지 않는 이유이다.

## 리스크 지표 (Risk Indicators)

위에서 논의한 많은 리스크 관리 조치는 반응적이다: 손실을 입으면 주문 규모를 줄이거나, 최대 낙폭에 도달하면 거래를 완전히 중단한다. 그러나 전략이 손실을 입을 가능성이 높은 기간을 선제적으로 피할 수 있다면 훨씬 더 유리할 것이다. 이것이 선행 리스크 지표의 역할이다.

선행 리스크 지표와 더 일반적인 리스크 지표 개념 사이의 명백한 구별은 선행 리스크 지표가 다음 기간이 투자에 위험할지 예측할 수 있게 해주는 반면, 일반 리스크 지표는 위험한 기간과 동시적일 뿐이라는 것이다.

모든 전략에 적용 가능한 하나의 리스크 지표는 없다: 한 전략에 위험한 기간이 다른 전략에는 매우 수익성 높은 기간일 수 있다. 예를 들어, VIX(내재 변동성 지수)를 선행 리스크 지표로 사용하여 4장에서 설명한 갭 매수 주식 전략의 다음 날 수익률 위험을 예측해 볼 수 있다. 그 전략은 2006년 5월 11일부터 2012년 4월 24일까지 약 8.7%의 연간화 평균 수익률과 1.5의 샤프 비율을 가졌다. 그러나 전날의 VIX가 35를 초과하면 (매우 위험한 기간의 일반적인 임계값), 당일의 연간화 평균 수익률은 17.2%이고 샤프 비율은 1.4가 된다. 분명히 이 전략은 소위 위험에서 혜택을 받는다! 그러나 VIX > 35는 7장에서 묘사한 FSTX 시가 갭 전략에 대해 매우 좋은 선행 리스크 지표이다. 그 전략은 2004년 7월 16일부터 2012년 5월 17일까지 약 13%의 연간화 평균 수익률과 1.4의 샤프 비율을 가졌다. 전날의 VIX가 35를 초과하면, 당일의 연간화 평균 수익률은 2.6%로 떨어지고 샤프 비율은 0.16이 된다. 분명히 VIX는 다음 날 거래를 피하라고 알려준다.

VIX 외에 또 다른 일반적으로 사용되는 선행 리스크 지표는 TED 스프레드이다. 이는 3개월 런던 은행간 금리(LIBOR)와 3개월 T-bill 금리의 차이이며, 은행 부도 위험을 측정한다. 2008년 신용 위기에서 TED 스프레드는 기록적인 457 베이시스 포인트로 상승했다. 신용 시장은 대형 기관 플레이어들이 지배하므로, 아마도 그들은 소매 투자자들의 군중 심리가 가치 평가에 기여하는 주식 시장에 기반한 지표보다 더 정보에 밝을 것이다. (TED 스프레드는 Snider and Youle, 2010이 발견한 것처럼 은행들이 LIBOR 금리를 더 낮게 보이도록 사기적으로 조작했음에도 불구하고 유용하다. 중요한 것은 절대적인 값이 아니라 시간에 따른 TED 스프레드의 상대적인 값이다.)

다른 시기에 리스크 지표로 사용된 다른 위험 자산들이 있지만, 이것들이 선행 지표인지 신중하게 테스트해야 할 것이다. 이러한 자산에는 하이일드 채권(예를 들어 ETF HYG로 대표됨)과 멕시코 페소(MXN)와 같은 신흥 시장 통화가 포함된다. 2011년 유럽 부채 위기 동안, 멕시코 경제가 건전하게 유지되었음에도 불구하고 MXN은 나쁜 뉴스에 특히 민감해졌다. 논평가들은 이 민감성을 트레이더들이 MXN을 일반적인 모든 위험 자산의 대리로 사용하고 있다는 사실에 기인했다.

더 최근에 트레이더들은 ETF ONN과 OFF도 주시할 수 있다. ONN은 시장이 "리스크-온" 분위기일 때, 즉 위험 자산의 가격이 상승할 때 상승한다. ONN은 기본적으로 위험 자산 바스켓을 보유한다. OFF는 ONN의 거울 이미지일 뿐이다. 따라서 OFF의 높은 값이 좋은 선행 리스크 지표일 수 있다. 이 글을 쓰는 시점에서 이 ETF들은 약 7개월의 역사만 있어서 예측 가치가 있는지 확인할 충분한 증거가 없다.

7장의 고빈도 거래 섹션에서 언급했듯이, 짧은 시간 척도에서 주문 흐름 정보에 접근할 수 있는 사람들은 주문 흐름의 갑작스럽고 큰 변화를 감지할 수 있으며, 이는 종종 기관 트레이더들이 중요한 정보를 입수했음을 나타낸다. 이 큰 주문 흐름 변화는 해당 자산이 주식, 원자재 또는 위험 통화와 같이 위험하다면 음수이고, 미국 국채나 USD, JPY, CHF와 같이 저위험 자산이라면 양수이다. 이전에 배웠듯이, 주문 흐름은 미래 가격 변화의 예측 변수이다 (Lyons, 2001). 따라서 주문 흐름은 그 정보가 시장에서 더 널리 확산되고 가격이 더 많이 변하기 전에 리스크의 단기 선행 지표로 사용될 수 있다.

전략에 매우 특화된 리스크 지표도 있다. 4장에서 유가가 GLD 대 GDX 페어 트레이딩의 좋은 선행 리스크 지표라고 언급했다. 금과 같은 다른 원자재 가격도 이를 생산하는 국가나 기업의 ETF 페어 트레이딩에 좋은 선행 리스크 지표일 수 있다. 마찬가지로 발틱 건화물 지수(Baltic Dry Index)는 수출 지향 국가의 ETF나 통화에 대한 좋은 선행 지표일 수 있다.

그러나 선행 리스크 지표의 백테스팅에 대한 한 가지 문제로 결론을 맺어야 한다. 금융 패닉이나 위기의 발생은 상대적으로 드물기 때문에, 지표가 유용한지 결정하려 할 때 데이터 스누핑 편향의 희생양이 되기 매우 쉽다. 그리고 물론 어떤 금융 지표도 자연재해나 다른 비금융적 재앙을 예측할 수 없다. 주문 흐름 지표가 더 높은 빈도로 작동하므로 이들 중 가장 유용할 수 있다.

## 핵심 요점 (Key Points)

- 장기 성장률 극대화:
  - 장기적으로 순자산을 극대화하는 것이 목표인가? 그렇다면 하프-켈리 최적 레버리지 사용을 고려하라.
  - 전략 수익률이 팻 테일인가? 켈리 공식에 의존하는 대신 몬테카를로 시뮬레이션을 사용하여 성장률을 최적화하고 싶을 수 있다.
  - 데이터 스누핑 편향을 염두에 두고, 때때로 백테스트 수익률의 복리 성장률에 기반하여 레버리지를 직접 최적화할 수 있다.
  - 낙폭이 사전 설정된 최대값을 초과하지 않도록 보장하면서도 가능한 최고의 성장률을 누리고 싶은가? 고정 비율 포트폴리오 보험을 사용하라.
- 손절매:
  - 손절매는 생존 편향으로 인해 평균 회귀 전략의 백테스트 성과를 보통 낮추지만, 블랙 스완 이벤트를 방지할 수 있다.
  - 평균 회귀 전략의 손절매는 백테스트에서 절대 발동되지 않도록 설정해야 한다.
  - 모멘텀 전략의 손절매는 그러한 전략의 자연스럽고 논리적인 부분을 형성한다.
- 리스크 지표:
  - 위험한 기간을 피하고 싶은가? 다음 가능한 선행 리스크 지표 중 하나를 고려할 수 있다: VIX, TED 스프레드, HYG, ONN/OFF, MXN.
  - 선행 리스크 지표의 효능을 테스트할 때 데이터 스누핑 편향을 주의하라.
  - 위험 자산의 점점 더 음수가 되는 주문 흐름은 단기 선행 리스크 지표가 될 수 있다.
